<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>MWA Point Tracker</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #0f172a;
  --surface: #1e293b;
  --surface2: #334155;
  --border: #475569;
  --text: #f1f5f9;
  --text-dim: #94a3b8;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --accent: #10b981;
  --accent2: #f59e0b;
  --danger: #ef4444;
  --purple: #8b5cf6;
  --radius: 10px;
  --bottom-nav: 64px;
  --header-h: 56px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* ===== HEADER ===== */
header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  height: var(--header-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
}

header h1 { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
.header-right { display: flex; align-items: center; gap: 12px; }
.header-pts { font-size: 0.95rem; color: var(--accent); font-weight: 700; }
.header-date-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 6px 10px;
  font-size: 0.8rem;
  cursor: pointer;
  min-height: 44px;
  display: flex;
  align-items: center;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--bottom-nav);
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 100;
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.bottom-nav button {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 0.65rem;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  min-height: 44px;
  padding: 4px 2px;
  transition: color 0.2s;
}

.bottom-nav button .nav-icon { font-size: 1.3rem; line-height: 1; }
.bottom-nav button.active { color: var(--primary); }
.bottom-nav button:active { color: var(--primary); }

/* ===== PAGES ===== */
.page {
  display: none;
  padding: calc(var(--header-h) + 12px) 12px calc(var(--bottom-nav) + 16px);
  max-width: 600px;
  margin: 0 auto;
}
.page.active { display: block; }

/* ===== CARDS ===== */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
}

.card h2 { font-size: 1rem; margin-bottom: 12px; color: var(--text); }
.card h3 { font-size: 0.9rem; margin-bottom: 8px; color: var(--text-dim); }

.card-collapse-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  min-height: 44px;
}

.card-collapse-header .arrow { transition: transform 0.2s; color: var(--text-dim); }
.card-collapse-header .arrow.open { transform: rotate(180deg); }
.card-collapse-body { overflow: hidden; transition: max-height 0.3s ease; }

/* ===== FORMS ===== */
.form-group { margin-bottom: 12px; }

.form-group label {
  display: block;
  font-size: 0.8rem;
  color: var(--text-dim);
  margin-bottom: 4px;
  font-weight: 500;
}

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-size: 16px; /* prevents iOS zoom */
  outline: none;
  transition: border-color 0.2s;
  min-height: 44px;
}

input:focus, select:focus, textarea:focus { border-color: var(--primary); }
textarea { resize: vertical; min-height: 60px; }

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  min-height: 44px;
}

.checkbox-group input[type="checkbox"] {
  width: 22px;
  height: 22px;
  accent-color: var(--primary);
  cursor: pointer;
  flex-shrink: 0;
}

.checkbox-group label {
  font-size: 0.9rem;
  color: var(--text);
  cursor: pointer;
  margin-bottom: 0;
}

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 20px;
  border: none;
  border-radius: 6px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  gap: 6px;
  min-height: 44px;
}

.btn-primary { background: var(--primary); color: white; width: 100%; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-primary:active { transform: scale(0.98); }
.btn-accent { background: var(--accent); color: white; }
.btn-danger { background: var(--danger); color: white; padding: 8px 14px; font-size: 0.85rem; }
.btn-sm { padding: 8px 14px; font-size: 0.85rem; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); }

/* ===== BADGES ===== */
.point-badge {
  display: inline-block;
  background: var(--primary);
  color: white;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}
.point-badge.large { font-size: 1.1rem; padding: 4px 14px; }
.point-badge.green { background: var(--accent); }
.point-badge.yellow { background: var(--accent2); color: #1e293b; }

/* ===== SUMMARY GRID ===== */
.summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }

.summary-item {
  background: var(--surface2);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}

.summary-item .label { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 4px; }
.summary-item .value { font-size: 1.3rem; font-weight: 700; }
.summary-item .value.blue { color: var(--primary); }
.summary-item .value.green { color: var(--accent); }
.summary-item .value.yellow { color: var(--accent2); }
.summary-item .value.purple { color: var(--purple); }

/* ===== TYPE SELECT GRIDS ===== */
.case-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }

.case-type-btn {
  padding: 12px 8px;
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.case-type-btn.selected { border-color: var(--accent); background: rgba(16,185,129,0.15); }
.case-type-btn:hover { border-color: var(--accent); }

/* ===== LISTS ===== */
.case-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--surface2);
  gap: 8px;
}
.case-list-item:last-child { border-bottom: none; }
.case-list-item .info { flex: 1; min-width: 0; }
.case-list-item .info h4 { font-size: 0.85rem; font-weight: 600; }
.case-list-item .info p { font-size: 0.75rem; color: var(--text-dim); }
.case-list-item .actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

.day-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: border-color 0.2s;
  min-height: 44px;
}
.day-list-item:hover { border-color: var(--primary); }
.day-list-item:active { border-color: var(--primary); background: var(--surface2); }
.day-list-item .date { font-weight: 600; font-size: 0.9rem; }
.day-list-item .meta { font-size: 0.75rem; color: var(--text-dim); }

/* ===== POINT BREAKDOWN ===== */
.point-breakdown {
  background: var(--surface2);
  border-radius: 8px;
  padding: 12px;
  margin-top: 12px;
}

.point-breakdown .row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.8rem; }

.point-breakdown .row.total {
  border-top: 1px solid var(--border);
  margin-top: 6px;
  padding-top: 8px;
  font-weight: 700;
  font-size: 0.9rem;
}

/* ===== MONTH NAV ===== */
.month-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin-bottom: 16px;
}

.month-nav button {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 8px 14px;
  cursor: pointer;
  font-size: 1rem;
  min-height: 44px;
  min-width: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.month-nav span { font-weight: 600; font-size: 1rem; min-width: 150px; text-align: center; }

/* ===== CHART ===== */
.chart-container { position: relative; height: 250px; margin: 12px 0; }

/* ===== RECONCILIATION ===== */
.recon-status { padding: 10px 14px; border-radius: 8px; margin-bottom: 8px; font-size: 0.85rem; }
.recon-match { background: rgba(16,185,129,0.15); border: 1px solid var(--accent); color: var(--accent); }
.recon-warn { background: rgba(245,158,11,0.15); border: 1px solid var(--accent2); color: var(--accent2); }
.recon-miss { background: rgba(239,68,68,0.15); border: 1px solid var(--danger); color: var(--danger); }

.recon-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
  margin: 8px 0;
}

.recon-table th, .recon-table td {
  padding: 8px 6px;
  text-align: left;
  border-bottom: 1px solid var(--surface2);
}

.recon-table th { color: var(--text-dim); font-weight: 600; font-size: 0.7rem; text-transform: uppercase; }
.recon-table td { vertical-align: top; }
.recon-table tr.match { background: rgba(16,185,129,0.07); }
.recon-table tr.warn { background: rgba(245,158,11,0.07); }
.recon-table tr.miss { background: rgba(239,68,68,0.07); }

/* ===== UPLOAD AREA ===== */
.upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s;
  min-height: 44px;
}

.upload-area:hover { border-color: var(--primary); }
.upload-area p { color: var(--text-dim); font-size: 0.85rem; margin-top: 8px; }
.upload-area input { display: none; }

/* ===== SHIFT TEMPLATES ===== */
.template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }

.template-btn {
  padding: 10px 8px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.8rem;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
  min-height: 44px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
}

.template-btn:hover { border-color: var(--primary); }
.template-btn:active { background: rgba(59,130,246,0.15); border-color: var(--primary); }
.template-btn .t-label { font-weight: 600; }
.template-btn .t-time { font-size: 0.7rem; color: var(--text-dim); }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: calc(var(--bottom-nav) + 16px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  z-index: 200;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  white-space: nowrap;
}
.toast.show { opacity: 1; }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 300;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 0;
}

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px 16px 0 0;
  padding: 20px;
  max-width: 600px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal h2 { margin-bottom: 16px; }

.modal-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
  justify-content: flex-end;
}

/* ===== TAB SWITCHER ===== */
.tab-bar {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-bottom: 12px;
  overflow-x: auto;
}

.tab-btn {
  flex: 1;
  padding: 10px 8px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-dim);
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  min-height: 44px;
  transition: all 0.2s;
}

.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

/* ===== MISC ===== */
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
.empty-state p { margin-top: 8px; font-size: 0.85rem; }
.divider { height: 1px; background: var(--border); margin: 16px 0; }
.hidden { display: none !important; }

/* ===== END TIME WARNING ===== */
.end-time-warning {
  background: rgba(245,158,11,0.15);
  border: 1px solid var(--accent2);
  color: var(--accent2);
  padding: 10px 14px;
  border-radius: 8px;
  margin-bottom: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}
input.warn-empty {
  border-color: var(--accent2) !important;
  box-shadow: 0 0 0 1px var(--accent2);
}

/* ===== MILITARY TIME INPUTS ===== */
input.mil-time {
  font-variant-numeric: tabular-nums;
  letter-spacing: 1px;
  text-align: center;
  font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
}
input.mil-time.invalid {
  border-color: var(--danger) !important;
}

.settings-field {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--surface2);
}

.settings-field label { font-size: 0.85rem; color: var(--text-dim); white-space: nowrap; min-width: 60px; }

/* ===== DASHBOARD SUB-TABS ===== */
.dash-tab-bar {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-bottom: 12px;
  overflow-x: auto;
  gap: 0;
}
.dash-tab-btn {
  flex: 1;
  padding: 10px 6px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-dim);
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  min-height: 44px;
  transition: all 0.2s;
  text-align: center;
}
.dash-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

/* ===== CASE LOG TABLE ===== */
.case-log-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -12px; padding: 0 12px; }
.case-log-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.72rem;
  min-width: 580px;
}
.case-log-table thead { position: sticky; top: 0; z-index: 2; }
.case-log-table th {
  background: var(--surface);
  color: var(--text-dim);
  font-weight: 600;
  font-size: 0.68rem;
  text-transform: uppercase;
  padding: 8px 6px;
  text-align: left;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
}
.case-log-table td {
  padding: 8px 6px;
  border-bottom: 1px solid var(--surface2);
  vertical-align: middle;
}
.case-log-table tr { cursor: pointer; transition: background 0.15s; }
.case-log-table tbody tr:hover { background: rgba(59,130,246,0.08); }
.case-log-table tbody tr:active { background: rgba(59,130,246,0.15); }

.case-log-search {
  width: 100%;
  padding: 8px 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-size: 14px;
  margin-bottom: 12px;
  outline: none;
  min-height: 44px;
}
.case-log-search:focus { border-color: var(--primary); }

/* ===== EFFICIENCY ITEMS ===== */
.efficiency-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid rgba(71,85,105,0.3);
  font-size: 0.82rem;
}
.efficiency-item:last-child { border-bottom: none; }
.efficiency-item .eff-label { flex: 1; min-width: 0; }
.efficiency-item .eff-value { font-weight: 700; margin-left: 8px; white-space: nowrap; }
.efficiency-item .eff-value.good { color: var(--accent); }
.efficiency-item .eff-value.bad { color: var(--danger); }

/* ===== TREND ARROWS ===== */
.trend-up { color: var(--accent); font-weight: 700; }
.trend-down { color: var(--danger); font-weight: 700; }
.trend-flat { color: var(--text-dim); font-weight: 700; }

/* ===== HEATMAP BARS ===== */
.heatmap-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 0.8rem;
}
.heatmap-row .hm-label { width: 36px; color: var(--text-dim); font-size: 0.75rem; flex-shrink: 0; }
.heatmap-bar {
  height: 20px;
  background: var(--primary);
  border-radius: 3px;
  min-width: 2px;
  transition: width 0.3s;
}
.heatmap-bar.green { background: var(--accent); }
.heatmap-row .hm-value { font-size: 0.75rem; color: var(--text-dim); min-width: 40px; text-align: right; }

/* ===== CASE MIX ITEMS ===== */
.case-mix-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  font-size: 0.8rem;
}
.case-mix-item .cm-label { width: 110px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.case-mix-bar-wrap { flex: 1; height: 16px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
.case-mix-bar { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s; }
.case-mix-item .cm-count { min-width: 32px; text-align: right; font-size: 0.75rem; color: var(--text-dim); }

/* ===== COLLAPSIBLE SECTIONS ===== */
.collapse-section { margin-bottom: 8px; }
.collapse-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  min-height: 44px;
  padding: 8px 0;
  border-bottom: 1px solid var(--surface2);
}
.collapse-header h3 { font-size: 0.88rem; margin: 0; }
.collapse-header .arrow { transition: transform 0.2s; color: var(--text-dim); }
.collapse-header .arrow.open { transform: rotate(180deg); }
.collapse-body { overflow: hidden; transition: max-height 0.3s ease; max-height: 0; }

/* ===== TIME ENTRY ROWS ===== */
.time-entry-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.time-entry-row input { flex: 1; }
.time-entry-row .te-label { font-size: 0.8rem; color: var(--text-dim); flex-shrink: 0; }
.remove-entry-btn {
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 6px;
  width: 36px;
  height: 36px;
  font-size: 1.1rem;
  cursor: pointer;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 36px;
}
.remove-entry-btn:disabled { opacity: 0.3; cursor: default; }
.add-entry-btn {
  background: transparent;
  border: 1px dashed var(--border);
  border-radius: 6px;
  color: var(--primary);
  padding: 8px;
  width: 100%;
  font-size: 0.85rem;
  cursor: pointer;
  margin-bottom: 12px;
  min-height: 38px;
  transition: border-color 0.2s;
}
.add-entry-btn:hover { border-color: var(--primary); }

/* ===== BOTTOM NAV — 6 items ===== */
.bottom-nav button { font-size: 0.58rem; }
.bottom-nav button .nav-icon { font-size: 1.15rem; }

@media (max-width: 480px) {
  .form-row { grid-template-columns: 1fr; }
  .form-row-3 { grid-template-columns: 1fr 1fr; }
  .template-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header>
  <h1>MWA Points</h1>
  <div class="header-right">
    <span class="header-pts" id="headerPoints">0 pts</span>
    <button class="header-date-btn" id="headerDateBtn"></button>
  </div>
</header>

<!-- ===== PAGES ===== -->

<!-- SHIFT PAGE -->
<div class="page active" id="page-shift">
  <div class="hidden" id="editShiftBanner" style="background:rgba(59,130,246,0.15); border:1px solid var(--primary); border-radius:var(--radius); padding:10px 14px; margin-bottom:12px; font-size:0.82rem; color:var(--primary); font-weight:600;"></div>
  <div class="end-time-warning hidden" id="endTimeWarning">
    Shift end time is missing — AR points will be 0 until an end time is entered.
  </div>
  <div class="card">
    <div class="card-collapse-header" id="templateCollapseHeader">
      <h2>Quick Templates</h2>
      <span class="arrow" id="templateArrow">&#9660;</span>
    </div>
    <div class="card-collapse-body" id="templateCollapseBody" style="max-height:0;">
      <div class="template-grid" id="templateGrid" style="padding-top:12px;"></div>
    </div>
  </div>

  <div class="card">
    <h2>Shift Setup</h2>

    <div class="form-group">
      <label>Date</label>
      <input type="date" id="shiftDate">
    </div>

    <div class="form-group">
      <label>Assignment Type</label>
      <select id="shiftAssignmentType">
        <option value="OR">OR / General</option>
        <option value="OB_restricted">UVH OB</option>
        <option value="cardiac_liver">Cardiac / Liver</option>
        <option value="mole">Mole</option>
        <option value="1st_call">1st Call</option>
        <option value="2nd_call">2nd Call</option>
        <option value="3rd_call">3rd Call</option>
        <option value="4th_call">4th Call</option>
        <option value="endo">Endo</option>
        <option value="SF1">SF 1</option>
        <option value="SF2">SF 2</option>
        <option value="ACS">ACS</option>
        <option value="NORA">NORA</option>
        <option value="CRNA_supervision">CRNA Supervision</option>
      </select>
    </div>

    <div class="form-group">
      <label>Time Entries</label>
      <div id="timeEntriesContainer">
        <div class="time-entry-row">
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time te-start" value="07:00">
          <span class="te-label">to</span>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time te-end" value="17:00">
          <button type="button" class="remove-entry-btn" disabled>&times;</button>
        </div>
      </div>
      <button type="button" class="add-entry-btn" id="addTimeEntryBtn">+ Add Time Entry</button>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="shiftHoliday">
      <label for="shiftHoliday">Holiday</label>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="shiftForcedOff">
      <label for="shiftForcedOff">Forced Off (no cases)</label>
    </div>

    <div id="cardiacLiverOptions" class="hidden">
      <div class="divider"></div>
      <h3>Subspecialty Options</h3>
      <div class="checkbox-group">
        <input type="checkbox" id="subspecCoverage">
        <label for="subspecCoverage">Subspecialty coverage (45 pts/day)</label>
      </div>
      <div class="form-group">
        <label>TEE Exams Performed</label>
        <input type="number" id="teeCount" value="0" min="0">
      </div>
    </div>

    <div id="supervisionOverlaySection" class="hidden">
      <div class="divider"></div>
      <h3>CRNA Supervision</h3>
      <div class="checkbox-group">
        <input type="checkbox" id="supervisionOverlayCheck">
        <label for="supervisionOverlayCheck">Add CRNA supervision period (7 pts/hr)</label>
      </div>
      <div class="form-row hidden" id="supervisionTimes">
        <div class="form-group">
          <label>Supervision Start</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="supervisionStart">
        </div>
        <div class="form-group">
          <label>Supervision End</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="supervisionEnd">
        </div>
      </div>
    </div>

    <div style="margin-top: 16px;">
      <button class="btn btn-primary" id="saveShiftBtn">Save Shift</button>
    </div>
  </div>
</div>

<!-- CASES PAGE -->
<div class="page" id="page-cases">
  <div class="card">
    <div class="card-collapse-header" id="quickProcCollapseHeader">
      <h2>Quick Procedures</h2>
      <span class="arrow" id="quickProcArrow">&#9660;</span>
    </div>
    <div class="card-collapse-body" id="quickProcCollapseBody" style="max-height:0;">
      <div class="template-grid" style="padding-top:12px;">
        <button class="template-btn" data-qproc="colonoscopy">
          <span class="t-label">Colonoscopy</span>
          <span class="t-time">4 base units</span>
        </button>
        <button class="template-btn" data-qproc="egd">
          <span class="t-label">EGD</span>
          <span class="t-time">5 base units</span>
        </button>
        <button class="template-btn" data-qproc="double">
          <span class="t-label">Double / EGD+Colo</span>
          <span class="t-time">5 base units</span>
        </button>
        <button class="template-btn" data-qproc="tonsils">
          <span class="t-label">Tonsils</span>
          <span class="t-time">5 base units</span>
        </button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Log a Case</h2>

    <div class="form-group">
      <label>Case Type</label>
      <div class="case-type-grid">
        <div class="case-type-btn selected" data-case="standard">Standard Case</div>
        <div class="case-type-btn" data-case="labor_epidural">Labor Epidural</div>
        <div class="case-type-btn" data-case="epidural_blood_patch">Epidural Blood Patch</div>
        <div class="case-type-btn" data-case="emergency_intubation">Emergency Intubation</div>
        <div class="case-type-btn" data-case="01996">Epidural Rounding (01996)</div>
        <div class="case-type-btn" data-case="99231">Pain Rounding (99231)</div>
        <div class="case-type-btn" data-case="tee">TEE Exam</div>
        <div class="case-type-btn" data-case="aps_rounding">APS Rounding</div>
      </div>
    </div>

    <div id="standardFields">
      <div class="form-group">
        <label>Procedure Name</label>
        <input type="text" id="caseProcedure" placeholder="e.g., Lap Chole, Total Knee">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>ASA Base Units</label>
          <input type="number" id="caseBaseUnits" min="0" step="1" value="0">
        </div>
        <div class="form-group">
          <label>Physical Status</label>
          <select id="casePhysicalStatus">
            <option value="P1">P1</option>
            <option value="P2">P2</option>
            <option value="P3" selected>P3</option>
            <option value="P4">P4</option>
            <option value="P5">P5</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Anesthesia Start</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="caseStart">
        </div>
        <div class="form-group">
          <label>Anesthesia End</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="caseEnd">
        </div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="caseEmergency">
        <label for="caseEmergency">Emergency Case (+1 pt)</label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="caseMedicalProc">
        <label for="caseMedicalProc">Medical Procedure (arterial/central line)</label>
      </div>

      <div class="form-group hidden" id="medicalUnitsRow">
        <label>ASA Medical Procedure Units</label>
        <input type="number" id="caseMedicalUnits" min="0" step="1" value="0">
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="caseAcutePain">
        <label for="caseAcutePain">Acute Pain Procedure</label>
      </div>

      <div class="form-group hidden" id="acutePainUnitsRow">
        <label>MWA Acute Pain Unit Value</label>
        <input type="number" id="caseAcutePainUnits" min="0" step="0.1" value="0">
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="caseHighRiskPeds">
        <label for="caseHighRiskPeds">High Risk Pediatrics (1.33x time)</label>
      </div>

      <div class="checkbox-group hidden" id="orCaseRow">
        <input type="checkbox" id="caseORCase">
        <label for="caseORCase">OR Case (use OR rates, no OB doubling)</label>
      </div>

      <div class="divider"></div>
      <h3>Add-Ons</h3>
      <div class="form-group">
        <label>Nerve Block</label>
        <select id="caseNerveBlock">
          <option value="none">None</option>
          <option value="brachial_plexus">Brachial Plexus (3 pts)</option>
          <option value="other">Other (2.6 pts)</option>
        </select>
      </div>
      <div class="form-row">
        <div class="checkbox-group">
          <input type="checkbox" id="caseCentralLine">
          <label for="caseCentralLine">Central Line (0.8 pts)</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="caseArterialLine">
          <label for="caseArterialLine">Arterial Line (0.6 pts)</label>
        </div>
      </div>
      <div class="form-row">
        <div class="checkbox-group">
          <input type="checkbox" id="casePAC">
          <label for="casePAC">PAC (2 pts)</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="caseTEEAddOn">
          <label for="caseTEEAddOn">TEE (0.4 pts)</label>
        </div>
      </div>
    </div>

    <div id="laborEpiduralFields" class="hidden">
      <div class="form-row">
        <div class="form-group">
          <label>Epidural Start</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="laborStart">
        </div>
        <div class="form-group">
          <label>Epidural End</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="laborEnd">
        </div>
      </div>
    </div>

    <div id="apsRoundingFields" class="hidden">
      <div class="form-row">
        <div class="form-group">
          <label>Epidural Rounds (3 pts each)</label>
          <input type="number" id="apsEpiduralCount" min="0" step="1" value="0">
        </div>
        <div class="form-group">
          <label>Pain Rounds (2 pts each)</label>
          <input type="number" id="apsPainCount" min="0" step="1" value="0">
        </div>
      </div>
    </div>

    <div id="simpleFields" class="hidden">
      <div class="form-group">
        <label>Procedure Notes (optional)</label>
        <input type="text" id="simpleNotes" placeholder="Optional notes">
      </div>
    </div>

    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="caseNotes" placeholder="Surgeon, location, or other notes"></textarea>
    </div>

    <div id="casePointPreview" class="point-breakdown hidden">
      <div class="row"><span>Estimated Points</span><span id="previewPoints">--</span></div>
    </div>

    <div style="margin-top: 16px;">
      <button class="btn btn-primary" id="saveCaseBtn">Save Case</button>
    </div>
  </div>
</div>

<!-- TODAY PAGE -->
<div class="page" id="page-today">
  <div class="card">
    <h2 id="todayTitle">Today's Summary</h2>
    <div class="summary-grid">
      <div class="summary-item">
        <div class="label">Availability (AR)</div>
        <div class="value blue" id="todayAR">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Productivity</div>
        <div class="value green" id="todayProd">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Call / Other</div>
        <div class="value yellow" id="todayCall">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Total Points</div>
        <div class="value" id="todayTotal">0</div>
      </div>
    </div>
  </div>

  <div class="card" id="todayBreakdownCard">
    <h2>Point Breakdown</h2>
    <div id="todayBreakdown"></div>
  </div>

  <div class="card">
    <h2>Cases <span id="todayCaseCount"></span></h2>
    <div id="todayCaseList">
      <div class="empty-state">
        <p>No cases logged yet.</p>
      </div>
    </div>
  </div>
</div>

<!-- RECONCILE PAGE -->
<div class="page" id="page-reconcile">
  <div class="tab-bar">
    <button class="tab-btn active" data-rtab="qgenda">QGenda Time</button>
    <button class="tab-btn" data-rtab="production">Production</button>
    <button class="tab-btn" data-rtab="import">Import</button>
  </div>

  <!-- QGenda Tab -->
  <div id="rtab-qgenda">
    <div class="card">
      <h2>QGenda Time Reconciliation</h2>
      <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:12px;">
        Upload your QGenda time punch export (.xlsx or .csv) or screenshot to compare against your tracked shifts.
      </p>
      <div class="upload-area" id="qgendaUploadArea">
        <div style="font-size:2rem;">&#128196;</div>
        <p>Tap to upload QGenda .xlsx, .csv, or screenshot</p>
        <input type="file" id="qgendaFile" accept=".xlsx,.xls,.csv,.png,.jpg,.jpeg">
      </div>
    </div>

    <div class="month-nav" style="margin-top:12px;">
      <button id="qPrevMonth">&larr;</button>
      <span id="qMonthLabel">January 2026</span>
      <button id="qNextMonth">&rarr;</button>
    </div>

    <div id="qgendaResults"></div>
  </div>

  <!-- Production Tab -->
  <div id="rtab-production" class="hidden">
    <div class="card">
      <h2>Production Reconciliation</h2>
      <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:12px;">
        Upload your Charge Detail PDF or screenshot to compare billing production against your tracked cases.
      </p>
      <div class="upload-area" id="prodUploadArea">
        <div style="font-size:2rem;">&#128196;</div>
        <p>Tap to upload Charge Detail PDF or screenshot</p>
        <input type="file" id="prodFile" accept=".pdf,.png,.jpg,.jpeg">
      </div>
    </div>

    <div class="month-nav" style="margin-top:12px;">
      <button id="pPrevMonth">&larr;</button>
      <span id="pMonthLabel">January 2026</span>
      <button id="pNextMonth">&rarr;</button>
    </div>

    <div id="prodResults"></div>
  </div>

  <!-- Import Tab -->
  <div id="rtab-import" class="hidden">
    <div class="tab-bar" id="importSubTabs">
      <button class="tab-btn active" data-itab="time">Time Punches</button>
      <button class="tab-btn" data-itab="cases">Cases</button>
    </div>

    <!-- Time Punch Import -->
    <div id="itab-time">
      <div class="card">
        <h2>Import Shifts from QGenda</h2>
        <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:12px;">
          Upload a QGenda time punch export (.xlsx, .csv, or screenshot) to import shifts into the tracker.
        </p>
        <div class="upload-area" id="importTimeUploadArea">
          <div style="font-size:2rem;">&#128197;</div>
          <p>Tap to upload QGenda .xlsx, .csv, or screenshot</p>
          <input type="file" id="importTimeFile" accept=".xlsx,.xls,.csv,.png,.jpg,.jpeg">
        </div>
      </div>
      <div id="importTimePreview"></div>
      <div id="importTimeAction" class="hidden" style="margin-top:12px;">
        <button class="btn btn-primary" id="importShiftsBtn" style="width:100%;">Import Shifts</button>
      </div>
    </div>

    <!-- Case Import -->
    <div id="itab-cases" class="hidden">
      <div class="card">
        <h2>Import Cases from CSV</h2>
        <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:12px;">
          Export a tab from your Google Sheet as CSV and upload it to import cases.
        </p>
        <div class="upload-area" id="csvUploadArea">
          <div style="font-size:2rem;">&#128203;</div>
          <p>Tap to upload CSV</p>
          <input type="file" id="csvFile" accept=".csv">
        </div>
      </div>
      <div id="csvImportResults"></div>
    </div>
  </div>
</div>

<!-- DASHBOARD PAGE -->
<div class="page" id="page-dashboard">
  <div class="dash-tab-bar">
    <button class="dash-tab-btn active" data-dtab="caselogs">Case Logs</button>
    <button class="dash-tab-btn" data-dtab="projections">Projections</button>
    <button class="dash-tab-btn" data-dtab="time">Time</button>
    <button class="dash-tab-btn" data-dtab="analytics">Analytics</button>
  </div>

  <!-- Case Logs Tab -->
  <div id="dtab-caselogs">
    <div class="month-nav">
      <button id="clPrevMonth">&larr;</button>
      <span id="clMonthLabel">January 2026</span>
      <button id="clNextMonth">&rarr;</button>
    </div>
    <input type="text" class="case-log-search" id="caseLogSearch" placeholder="Search cases...">
    <div class="case-log-wrap">
      <div id="caseLogTableContainer">
        <div class="empty-state"><p>No cases for this month.</p></div>
      </div>
    </div>
  </div>

  <!-- Projections Tab -->
  <div id="dtab-projections" class="hidden">
    <!-- Stabilization Card -->
    <div class="card">
      <h2>Stabilization-Weighted Points</h2>
      <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:12px;">
        Weighted: 10% current + 40% prior + 25% 2-mo + 15% 3-mo + 10% 4-mo
      </p>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="label">Raw This Month</div>
          <div class="value blue" id="stabRaw">0</div>
        </div>
        <div class="summary-item">
          <div class="label">Stabilized</div>
          <div class="value green" id="stabWeighted">0</div>
        </div>
      </div>
      <div id="stabPaycheckRow" style="margin-top:12px; text-align:center;">
        <div style="font-size:1.3rem; font-weight:700; color:var(--accent2);" id="stabPaycheck">&mdash;</div>
        <div style="font-size:0.75rem; color:var(--text-dim); margin-top:4px;">Projected next month's paycheck</div>
      </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="card">
      <h2>Monthly Trend</h2>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
      <div id="monthlyChartSummary" style="margin-top:10px; font-size:0.82rem; color:var(--text-dim); text-align:center;"></div>
    </div>

    <!-- Projected Annual Income -->
    <div class="card">
      <h2>Projected Annual Income</h2>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="label">3-Month Rolling Avg</div>
          <div class="value blue" id="projRollingAvg">0</div>
        </div>
        <div class="summary-item">
          <div class="label">Annual Projection</div>
          <div class="value green" id="projAnnualIncome">&mdash;</div>
        </div>
      </div>
    </div>

    <!-- Collapsible: Breakdown Chart -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('projBreakdown')">
        <h3>Points Breakdown (This Month)</h3>
        <span class="arrow" id="projBreakdownArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="projBreakdownBody">
        <div class="chart-container" style="margin-top:12px;">
          <canvas id="breakdownChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Collapsible: Shift Efficiency -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('projEfficiency')">
        <h3>Most / Least Efficient Shifts</h3>
        <span class="arrow" id="projEfficiencyArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="projEfficiencyBody">
        <div id="efficiencyContent" style="padding-top:12px;"></div>
      </div>
    </div>

    <!-- Collapsible: Month-over-Month -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('projMoM')">
        <h3>Month-over-Month Change</h3>
        <span class="arrow" id="projMoMArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="projMoMBody">
        <div id="momContent" style="padding-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Time Tab -->
  <div id="dtab-time" class="hidden">
    <!-- Summary Cards -->
    <div class="card">
      <h2>Time Summary (Past 3 Months)</h2>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="label">Avg Hours/Month</div>
          <div class="value blue" id="timeAvgMonth">0</div>
        </div>
        <div class="summary-item">
          <div class="label">Avg Hours/Week</div>
          <div class="value green" id="timeAvgWeek">0</div>
        </div>
        <div class="summary-item">
          <div class="label">Avg Shift Start</div>
          <div class="value yellow" id="timeAvgStart">--:--</div>
        </div>
        <div class="summary-item">
          <div class="label">Avg Shift End</div>
          <div class="value purple" id="timeAvgEnd">--:--</div>
        </div>
      </div>
    </div>

    <!-- Production Trend -->
    <div class="card">
      <h2>Monthly Production Trend</h2>
      <div class="chart-container">
        <canvas id="productionTrendChart"></canvas>
      </div>
    </div>

    <!-- Collapsible: Day-of-Week Breakdown -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('timeDOW')">
        <h3>Day-of-Week Breakdown</h3>
        <span class="arrow" id="timeDOWArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="timeDOWBody">
        <div id="dowContent" style="padding-top:12px;"></div>
      </div>
    </div>

    <!-- Collapsible: Weekend vs Weekday -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('timeWknd')">
        <h3>Weekend vs Weekday</h3>
        <span class="arrow" id="timeWkndArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="timeWkndBody">
        <div id="wkndContent" style="padding-top:12px;"></div>
      </div>
    </div>

    <!-- Collapsible: Night & Call Frequency -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('timeNight')">
        <h3>Night &amp; Call Shift Frequency</h3>
        <span class="arrow" id="timeNightArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="timeNightBody">
        <div id="nightContent" style="padding-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Analytics Tab -->
  <div id="dtab-analytics" class="hidden">
    <!-- Case Mix -->
    <div class="card">
      <h2>Case Mix</h2>
      <div id="caseMixContent">
        <div class="empty-state"><p>No case data.</p></div>
      </div>
    </div>

    <!-- Collapsible: Add-on Utilization -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('analAddOns')">
        <h3>Add-On Utilization</h3>
        <span class="arrow" id="analAddOnsArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="analAddOnsBody">
        <div id="addOnContent" style="padding-top:12px;"></div>
      </div>
    </div>

    <!-- Collapsible: Top Procedures by Points -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('analTopProc')">
        <h3>Top Procedures by Points</h3>
        <span class="arrow" id="analTopProcArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="analTopProcBody">
        <div id="topProcContent" style="padding-top:12px;"></div>
      </div>
    </div>

    <!-- Collapsible: Average Units per Case -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('analAvgUnits')">
        <h3>Average Units per Case</h3>
        <span class="arrow" id="analAvgUnitsArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="analAvgUnitsBody">
        <div id="avgUnitsContent" style="padding-top:12px;"></div>
      </div>
    </div>

    <!-- Shift Type Distribution -->
    <div class="card collapse-section">
      <div class="collapse-header" onclick="toggleCollapse('analShiftDist')">
        <h3>Shift Type Distribution</h3>
        <span class="arrow" id="analShiftDistArrow">&#9660;</span>
      </div>
      <div class="collapse-body" id="analShiftDistBody">
        <div class="chart-container" style="margin-top:12px;">
          <canvas id="shiftDistChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS PAGE -->
<div class="page" id="page-settings">
  <!-- Settings -->
  <div class="card">
    <h2>Settings</h2>
    <div class="settings-field">
      <label>Name</label>
      <input type="text" id="settingsName" placeholder="Your name (labels exports)">
    </div>
    <div class="settings-field" style="margin-top:12px;">
      <label>Point Value ($/pt)</label>
      <input type="number" id="settingsPointValue" min="0" step="0.01" style="max-width:140px;">
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <h2>Monthly History</h2>
    <div class="month-nav">
      <button id="prevMonth">&larr;</button>
      <span id="historyMonth">January 2026</span>
      <button id="nextMonth">&rarr;</button>
    </div>
    <div class="summary-grid">
      <div class="summary-item">
        <div class="label">Monthly Total</div>
        <div class="value blue" id="monthTotal">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Days Worked</div>
        <div class="value green" id="monthDays">0</div>
      </div>
    </div>
    <div id="historyList">
      <div class="empty-state"><p>No shifts recorded for this month.</p></div>
    </div>
  </div>

  <!-- Export / Import -->
  <div class="card">
    <h2>Data Management</h2>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-outline btn-sm" id="exportCSVBtn">Export CSV</button>
      <button class="btn btn-outline btn-sm" id="exportAllBtn">Export JSON</button>
      <label class="btn btn-outline btn-sm" style="cursor:pointer;">
        Import JSON
        <input type="file" id="importFile" accept=".json" style="display:none;">
      </label>
      <button class="btn btn-danger btn-sm" id="clearAllBtn">Clear All Data</button>
    </div>
  </div>
</div>

<!-- Day detail modal -->
<div class="modal-overlay hidden" id="dayModal">
  <div class="modal">
    <h2 id="dayModalTitle">Day Details</h2>
    <div id="dayModalContent"></div>
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" id="closeDayModal">Close</button>
    </div>
  </div>
</div>

<!-- Date picker modal -->
<div class="modal-overlay hidden" id="datePickerModal">
  <div class="modal">
    <h2>Select Working Date</h2>
    <div class="form-group">
      <input type="date" id="globalDatePicker">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" id="cancelDatePicker">Cancel</button>
      <button class="btn btn-primary btn-sm" id="applyDatePicker" style="width:auto;">Apply</button>
    </div>
  </div>
</div>

<!-- Case edit modal -->
<div class="modal-overlay hidden" id="caseEditModal">
  <div class="modal">
    <h2>Edit Case</h2>
    <div class="form-group">
      <label>Case Type</label>
      <div class="case-type-grid" id="editCaseTypeGrid">
        <div class="case-type-btn selected" data-ecase="standard">Standard Case</div>
        <div class="case-type-btn" data-ecase="labor_epidural">Labor Epidural</div>
        <div class="case-type-btn" data-ecase="epidural_blood_patch">Epidural Blood Patch</div>
        <div class="case-type-btn" data-ecase="emergency_intubation">Emergency Intubation</div>
        <div class="case-type-btn" data-ecase="01996">Epidural Rounding (01996)</div>
        <div class="case-type-btn" data-ecase="99231">Pain Rounding (99231)</div>
        <div class="case-type-btn" data-ecase="tee">TEE Exam</div>
        <div class="case-type-btn" data-ecase="aps_rounding">APS Rounding</div>
      </div>
    </div>
    <div id="editStandardFields">
      <div class="form-group">
        <label>Procedure Name</label>
        <input type="text" id="editCaseProcedure" placeholder="e.g., Lap Chole">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ASA Base Units</label>
          <input type="number" id="editCaseBaseUnits" min="0" step="1" value="0">
        </div>
        <div class="form-group">
          <label>Physical Status</label>
          <select id="editCasePhysicalStatus">
            <option value="P1">P1</option>
            <option value="P2">P2</option>
            <option value="P3" selected>P3</option>
            <option value="P4">P4</option>
            <option value="P5">P5</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Anesthesia Start</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="editCaseStart">
        </div>
        <div class="form-group">
          <label>Anesthesia End</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="editCaseEnd">
        </div>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="editCaseEmergency">
        <label for="editCaseEmergency">Emergency Case (+1 pt)</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="editCaseMedicalProc">
        <label for="editCaseMedicalProc">Medical Procedure</label>
      </div>
      <div class="form-group hidden" id="editMedicalUnitsRow">
        <label>ASA Medical Procedure Units</label>
        <input type="number" id="editCaseMedicalUnits" min="0" step="1" value="0">
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="editCaseAcutePain">
        <label for="editCaseAcutePain">Acute Pain Procedure</label>
      </div>
      <div class="form-group hidden" id="editAcutePainUnitsRow">
        <label>MWA Acute Pain Unit Value</label>
        <input type="number" id="editCaseAcutePainUnits" min="0" step="0.1" value="0">
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="editCaseHighRiskPeds">
        <label for="editCaseHighRiskPeds">High Risk Pediatrics (1.33x time)</label>
      </div>
      <div class="checkbox-group hidden" id="editORCaseRow">
        <input type="checkbox" id="editCaseORCase">
        <label for="editCaseORCase">OR Case (use OR rates, no OB doubling)</label>
      </div>

      <div class="divider"></div>
      <h3>Add-Ons</h3>
      <div class="form-group">
        <label>Nerve Block</label>
        <select id="editNerveBlock">
          <option value="none">None</option>
          <option value="brachial_plexus">Brachial Plexus (3 pts)</option>
          <option value="other">Other (2.6 pts)</option>
        </select>
      </div>
      <div class="form-row">
        <div class="checkbox-group">
          <input type="checkbox" id="editCentralLine">
          <label for="editCentralLine">Central Line (0.8 pts)</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="editArterialLine">
          <label for="editArterialLine">Arterial Line (0.6 pts)</label>
        </div>
      </div>
      <div class="form-row">
        <div class="checkbox-group">
          <input type="checkbox" id="editPAC">
          <label for="editPAC">PAC (2 pts)</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="editTEEAddOn">
          <label for="editTEEAddOn">TEE (0.4 pts)</label>
        </div>
      </div>
    </div>
    <div id="editLaborEpiduralFields" class="hidden">
      <div class="form-row">
        <div class="form-group">
          <label>Epidural Start</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="editLaborStart">
        </div>
        <div class="form-group">
          <label>Epidural End</label>
          <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time" id="editLaborEnd">
        </div>
      </div>
    </div>
    <div id="editApsRoundingFields" class="hidden">
      <div class="form-row">
        <div class="form-group">
          <label>Epidural Rounds (3 pts each)</label>
          <input type="number" id="editApsEpiduralCount" min="0" step="1" value="0">
        </div>
        <div class="form-group">
          <label>Pain Rounds (2 pts each)</label>
          <input type="number" id="editApsPainCount" min="0" step="1" value="0">
        </div>
      </div>
    </div>
    <div id="editSimpleFields" class="hidden">
      <div class="form-group">
        <label>Procedure Notes (optional)</label>
        <input type="text" id="editSimpleNotes" placeholder="Optional notes">
      </div>
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <textarea id="editCaseNotes" placeholder="Notes"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" id="cancelCaseEdit">Cancel</button>
      <button class="btn btn-primary btn-sm" id="saveCaseEdit" style="width:auto;">Save</button>
    </div>
  </div>
</div>

<!-- Import confirmation modal -->
<div class="modal-overlay hidden" id="importConfirmModal">
  <div class="modal">
    <h2 id="importConfirmTitle">Confirm Import</h2>
    <div id="importConfirmBody"></div>
    <div class="modal-actions">
      <button class="btn btn-outline btn-sm" id="cancelImport">Cancel</button>
      <button class="btn btn-primary btn-sm" id="confirmImport" style="width:auto;">Import</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="active" data-page="shift">
    <span class="nav-icon">&#128197;</span>
    <span>Shift</span>
  </button>
  <button data-page="cases">
    <span class="nav-icon">&#128203;</span>
    <span>Cases</span>
  </button>
  <button data-page="today">
    <span class="nav-icon">&#11088;</span>
    <span>Today</span>
  </button>
  <button data-page="reconcile">
    <span class="nav-icon">&#128260;</span>
    <span>Reconcile</span>
  </button>
  <button data-page="dashboard">
    <span class="nav-icon">&#128202;</span>
    <span>Dashboard</span>
  </button>
  <button data-page="settings">
    <span class="nav-icon">&#9881;</span>
    <span>Settings</span>
  </button>
</div>

<script>
// ================================================================
// DATA STORE
// ================================================================
const STORAGE_KEY = 'mwa_point_tracker';
const SETTINGS_KEY = 'mwa_settings';
const QGENDA_KEY = 'mwa_qgenda';
const PROD_KEY = 'mwa_production';

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { shifts: {}, cases: [] };
}

function saveData(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
}

function loadSettings() {
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { name: '', templates: [] };
}

function saveSettings(s) {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
}

let data = loadData();
let settings = loadSettings();

// Data migration (idempotent)
function migrateData(d) {
  let changed = false;
  // Migrate eModifier → isEmergency on cases
  d.cases.forEach(c => {
    if (c.eModifier) {
      c.isEmergency = true;
      delete c.eModifier;
      changed = true;
    }
  });
  // Migrate OB_unrestricted → OR on shifts
  Object.values(d.shifts).forEach(s => {
    if (s.assignmentType === 'OB_unrestricted') {
      s.assignmentType = 'OR';
      changed = true;
    }
    // Ensure supervision overlay fields
    if (s.supervisionStart === undefined) { s.supervisionStart = ''; changed = true; }
    if (s.supervisionEnd === undefined) { s.supervisionEnd = ''; changed = true; }
  });
  // Ensure isORCase on all cases
  d.cases.forEach(c => {
    if (c.isORCase === undefined) { c.isORCase = false; changed = true; }
  });
  // Migrate shifts to timeEntries array
  Object.values(d.shifts).forEach(s => {
    if (!s.timeEntries) {
      s.timeEntries = [];
      if (s.startTime) {
        s.timeEntries.push({ start: s.startTime, end: s.endTime || '' });
      }
      changed = true;
    }
  });
  if (changed) saveData(d);
}
migrateData(data);

// ================================================================
// CONSTANTS & HELPERS
// ================================================================
const UNRESTRICTED_CALL_TYPES = new Set(['mole','1st_call','2nd_call','3rd_call','4th_call','endo','SF1','SF2']);

// Returns true if the given minute is eligible for unrestricted call pay (3.5 pts/hr)
// minuteOfDay: 0-1439, isWeekendOrHoliday: boolean
function isUnrestrictedCallEligible(assignmentType, minuteOfDay, isWeekendOrHoliday) {
  switch (assignmentType) {
    case 'SF1':
    case 'SF2':
    case '1st_call':
    case '2nd_call':
    case '3rd_call':
      return isWeekendOrHoliday ? true : (minuteOfDay >= 1020); // after 17:00
    case '4th_call':
      return isWeekendOrHoliday; // weekend only shift
    case 'mole':
      return isWeekendOrHoliday ? true : (minuteOfDay >= 1140); // after 19:00
    case 'endo':
      return !isWeekendOrHoliday && (minuteOfDay >= 1020); // weekday after 17:00 only
    default:
      return false; // OR, OB, Cardiac/Liver, NORA, ACS, CRNA Supervision
  }
}

function getAssignmentTypeName(type) {
  const names = {
    OR: 'OR / General', OB_restricted: 'UVH OB', cardiac_liver: 'Cardiac / Liver',
    mole: 'Mole', '1st_call': '1st Call', '2nd_call': '2nd Call', '3rd_call': '3rd Call', '4th_call': '4th Call',
    endo: 'Endo', SF1: 'SF 1', SF2: 'SF 2', ACS: 'ACS', NORA: 'NORA',
    CRNA_supervision: 'CRNA Supervision'
  };
  return names[type] || type;
}

// ================================================================
// UTILITY
// ================================================================
function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function formatDateShort(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function timeToMinutes(timeStr) {
  if (!timeStr) return 0;
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

function isWeekend(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  const day = d.getDay();
  return day === 0 || day === 6;
}

function round2(n) {
  return Math.round(n * 100) / 100;
}

// ================================================================
// MILITARY TIME INPUT HANDLING
// ================================================================
function formatMilTimeInput(val) {
  const digits = val.replace(/[^0-9]/g, '');
  if (digits.length === 0) return '';
  if (digits.length <= 2) {
    const h = parseInt(digits);
    if (h > 23) return '';
    return digits;
  }
  let h, m;
  if (digits.length === 3) {
    h = parseInt(digits.substring(0, 1));
    m = parseInt(digits.substring(1, 3));
    if (h > 2 || m > 59) return digits.substring(0, 2) + ':' + digits.substring(2);
    return '0' + digits.substring(0, 1) + ':' + digits.substring(1, 3);
  }
  h = parseInt(digits.substring(0, 2));
  m = parseInt(digits.substring(2, 4));
  if (h > 23) h = 23;
  if (m > 59) m = 59;
  return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
}

function isValidMilTime(val) {
  if (!val) return true; // empty is allowed
  return /^([01]\d|2[0-3]):[0-5]\d$/.test(val);
}

function bindMilTimeInput(input) {
  input.addEventListener('input', function() {
    const digits = this.value.replace(/[^0-9]/g, '');
    // When 4+ digits entered (e.g. "1900"), format immediately to "19:00"
    if (digits.length >= 4 && !this.value.includes(':')) {
      this.value = formatMilTimeInput(this.value);
      this.setSelectionRange(this.value.length, this.value.length);
      return;
    }
    // Auto-insert colon after 2 digits while typing
    if (digits.length >= 2 && !this.value.includes(':')) {
      const pos = this.selectionStart;
      this.value = digits.substring(0, 2) + ':' + digits.substring(2, 4);
      this.setSelectionRange(pos + 1, pos + 1);
    }
  });

  input.addEventListener('blur', function() {
    if (this.value) {
      this.value = formatMilTimeInput(this.value);
    }
    this.classList.toggle('invalid', this.value && !isValidMilTime(this.value));
  });

  // Allow typing only digits and colon
  input.addEventListener('keypress', function(e) {
    if (e.key.length === 1 && !/[0-9:]/.test(e.key)) {
      e.preventDefault();
    }
  });
}

function initMilTimeInputs() {
  document.querySelectorAll('input.mil-time').forEach(input => bindMilTimeInput(input));
}

// ================================================================
// DYNAMIC TIME ENTRIES
// ================================================================
function createTimeEntryRow(start, end) {
  const row = document.createElement('div');
  row.className = 'time-entry-row';
  row.innerHTML = `
    <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time te-start" value="${start || ''}">
    <span class="te-label">to</span>
    <input type="text" inputmode="numeric" placeholder="HH:MM" maxlength="5" class="mil-time te-end" value="${end || ''}">
    <button type="button" class="remove-entry-btn">&times;</button>
  `;
  row.querySelectorAll('input.mil-time').forEach(input => bindMilTimeInput(input));
  row.querySelector('.remove-entry-btn').addEventListener('click', function() {
    row.remove();
    updateRemoveButtons();
  });
  return row;
}

function addTimeEntry() {
  const container = document.getElementById('timeEntriesContainer');
  const row = createTimeEntryRow('', '');
  container.appendChild(row);
  updateRemoveButtons();
  // Focus the new start input
  row.querySelector('.te-start').focus();
}

function updateRemoveButtons() {
  const rows = document.querySelectorAll('#timeEntriesContainer .time-entry-row');
  rows.forEach(row => {
    const btn = row.querySelector('.remove-entry-btn');
    btn.disabled = rows.length <= 1;
  });
}

function collectTimeEntries() {
  const rows = document.querySelectorAll('#timeEntriesContainer .time-entry-row');
  const entries = [];
  rows.forEach(row => {
    const start = row.querySelector('.te-start').value.trim();
    const end = row.querySelector('.te-end').value.trim();
    if (start || end) entries.push({ start, end });
  });
  return entries;
}

function populateTimeEntries(entries) {
  const container = document.getElementById('timeEntriesContainer');
  container.innerHTML = '';
  if (!entries || entries.length === 0) entries = [{ start: '07:00', end: '' }];
  entries.forEach(e => {
    container.appendChild(createTimeEntryRow(e.start, e.end));
  });
  updateRemoveButtons();
}

document.getElementById('addTimeEntryBtn').addEventListener('click', addTimeEntry);

// ================================================================
// POINT CALCULATION ENGINE (preserved from v1)
// ================================================================
function getARRate(assignmentType, isHol, isWknd, timeMinutes) {
  const isDaytime = timeMinutes >= 420 && timeMinutes < 1020;
  let baseRate;
  if (assignmentType === 'SF1') {
    // SF1: 13/hr during 0700-1700, General rate (20/hr) outside
    baseRate = isDaytime ? 13 : 20;
  } else {
    const isOB = ['OB_restricted','SF2'].includes(assignmentType);
    baseRate = isOB ? 13 : 20;
  }
  if (isHol || isWknd) {
    if (isDaytime) return baseRate * 1.10;
    else return baseRate * 1.25;
  } else {
    if (isDaytime) return baseRate;
    else if (timeMinutes >= 1020 && timeMinutes < 1380) return baseRate * 1.10;
    else return baseRate * 1.25;
  }
}

function calcARPoints(shift) {
  if (shift.forcedOff) return 56;
  const entries = shift.timeEntries || [];
  if (entries.length === 0) return 0;
  // Check if any entry has an end time
  const lastEntry = entries[entries.length - 1];
  if (!lastEntry.end && entries.length === 1) return 0;

  const isHol = shift.isHoliday;
  const isWknd = isWeekend(shift.date);
  const isWkndOrHol = isHol || isWknd;
  const isSF = ['SF1','SF2'].includes(shift.assignmentType);

  // Build OR-case time ranges for SF1/SF2
  let orRanges = [];
  if (isSF) {
    const shiftCases = data.cases.filter(c => c.shiftDate === shift.date && c.isORCase);
    shiftCases.forEach(c => {
      let cs = timeToMinutes(c.startTime);
      let ce = timeToMinutes(c.endTime);
      if (ce <= cs) ce += 1440;
      orRanges.push({ start: cs, end: ce });
    });
  }

  // Build clocked-in ranges from timeEntries
  const clockedRanges = [];
  entries.forEach(e => {
    if (!e.start) return;
    const s = timeToMinutes(e.start);
    let en = e.end ? timeToMinutes(e.end) : s; // no end = zero duration
    if (en <= s && e.end) en += 1440;
    clockedRanges.push({ start: s, end: en });
  });

  if (clockedRanges.length === 0) return 0;

  // Full span: first entry start → last entry end
  const spanStart = clockedRanges[0].start;
  const spanEnd = clockedRanges[clockedRanges.length - 1].end;
  if (spanEnd <= spanStart) return 0;

  let arPoints = 0;
  let callPoints = 0;

  for (let m = spanStart; m < spanEnd; m++) {
    const normalizedMin = m % 1440;

    // Is this minute within a clocked-in range?
    let clockedIn = false;
    for (const r of clockedRanges) {
      if (m >= r.start && m < r.end) { clockedIn = true; break; }
    }

    if (clockedIn) {
      // Normal AR rate
      let rateType = shift.assignmentType;
      if (isSF) {
        for (const r of orRanges) {
          if (m >= r.start && m < r.end) { rateType = 'OR'; break; }
        }
      }
      arPoints += getARRate(rateType, isHol, isWknd, normalizedMin) / 60;
    } else {
      // Gap minute — check unrestricted call eligibility
      if (isUnrestrictedCallEligible(shift.assignmentType, normalizedMin, isWkndOrHol)) {
        callPoints += 3.5 / 60; // flat 3.5 pts/hr, no multipliers
      }
    }
  }

  // Guaranteed minimums for clocked-in time (weekday, non-mole)
  if (!isHol && !isWknd && shift.assignmentType !== 'mole') {
    const isOBRate = ['OB_restricted','SF1','SF2'].includes(shift.assignmentType);
    const minPoints = isOBRate ? 13 * 4 : 20 * 4;
    arPoints = Math.max(arPoints, minPoints);
  }

  return round2(arPoints + callPoints);
}

// Separate getter for breakdown display purposes
function calcARBreakdown(shift) {
  if (shift.forcedOff) return { ar: 56, call: 0 };
  const entries = shift.timeEntries || [];
  if (entries.length === 0) return { ar: 0, call: 0 };
  const lastEntry = entries[entries.length - 1];
  if (!lastEntry.end && entries.length === 1) return { ar: 0, call: 0 };

  const isHol = shift.isHoliday;
  const isWknd = isWeekend(shift.date);
  const isWkndOrHol = isHol || isWknd;
  const isSF = ['SF1','SF2'].includes(shift.assignmentType);

  let orRanges = [];
  if (isSF) {
    const shiftCases = data.cases.filter(c => c.shiftDate === shift.date && c.isORCase);
    shiftCases.forEach(c => {
      let cs = timeToMinutes(c.startTime);
      let ce = timeToMinutes(c.endTime);
      if (ce <= cs) ce += 1440;
      orRanges.push({ start: cs, end: ce });
    });
  }

  const clockedRanges = [];
  entries.forEach(e => {
    if (!e.start) return;
    const s = timeToMinutes(e.start);
    let en = e.end ? timeToMinutes(e.end) : s;
    if (en <= s && e.end) en += 1440;
    clockedRanges.push({ start: s, end: en });
  });

  if (clockedRanges.length === 0) return { ar: 0, call: 0 };

  const spanStart = clockedRanges[0].start;
  const spanEnd = clockedRanges[clockedRanges.length - 1].end;
  if (spanEnd <= spanStart) return { ar: 0, call: 0 };

  let arPoints = 0;
  let callPoints = 0;

  for (let m = spanStart; m < spanEnd; m++) {
    const normalizedMin = m % 1440;
    let clockedIn = false;
    for (const r of clockedRanges) {
      if (m >= r.start && m < r.end) { clockedIn = true; break; }
    }
    if (clockedIn) {
      let rateType = shift.assignmentType;
      if (isSF) {
        for (const r of orRanges) {
          if (m >= r.start && m < r.end) { rateType = 'OR'; break; }
        }
      }
      arPoints += getARRate(rateType, isHol, isWknd, normalizedMin) / 60;
    } else {
      if (isUnrestrictedCallEligible(shift.assignmentType, normalizedMin, isWkndOrHol)) {
        callPoints += 3.5 / 60;
      }
    }
  }

  if (!isHol && !isWknd && shift.assignmentType !== 'mole') {
    const isOBRate = ['OB_restricted','SF1','SF2'].includes(shift.assignmentType);
    const minPoints = isOBRate ? 13 * 4 : 20 * 4;
    arPoints = Math.max(arPoints, minPoints);
  }

  return { ar: round2(arPoints), call: round2(callPoints) };
}

function getTimeMultiplier(physicalStatus, isHol, isWknd, caseStartMin, isHighRiskPeds) {
  const isWeekdayDay = !isHol && !isWknd && caseStartMin >= 420 && caseStartMin < 1020;
  const isWeekdayEve = !isHol && !isWknd && caseStartMin >= 1020 && caseStartMin < 1380;
  const isWeekendDay = (isHol || isWknd) && caseStartMin >= 420 && caseStartMin < 1020;
  let multiplier = 1.0;
  if (physicalStatus === 'P4') {
    if (isWeekdayDay) multiplier = 1.33;
  } else if (physicalStatus === 'P5') {
    if (isWeekdayDay) multiplier = 1.83;
    else if (isWeekdayEve || isWeekendDay) multiplier = 1.5;
  }
  if (isHighRiskPeds && isWeekdayDay && multiplier < 1.33) multiplier = 1.33;
  return multiplier;
}

function calcAddOnPoints(caseData) {
  let pts = 0;
  if (caseData.nerveBlock === 'brachial_plexus') pts += 3;
  else if (caseData.nerveBlock === 'other') pts += 2.6;
  if (caseData.hasCentralLine) pts += 0.8;
  if (caseData.hasArterialLine) pts += 0.6;
  if (caseData.hasPAC) pts += 2;
  if (caseData.hasTEEAddOn) pts += 0.4;
  return pts;
}

function calcCasePoints(caseData, shift) {
  const ct = caseData.caseType;
  if (ct === 'epidural_blood_patch') return 5;
  if (ct === 'emergency_intubation') return 4;
  if (ct === '01996') return 3;
  if (ct === '99231') return 2;
  if (ct === 'tee') return 22;

  if (ct === 'aps_rounding') {
    const epi = (parseInt(caseData.epiduralRounds) || 0) * 3;
    const pain = (parseInt(caseData.painRounds) || 0) * 2;
    return round2(epi + pain);
  }

  if (ct === 'labor_epidural') {
    let cs = timeToMinutes(caseData.startTime);
    let ce = timeToMinutes(caseData.endTime);
    if (ce <= cs) ce += 1440;
    const durationHrs = Math.min((ce - cs) / 60, 24);
    let pts = 0;
    if (durationHrs > 0) pts += Math.min(durationHrs, 1) * 7.5;
    if (durationHrs > 1) pts += Math.min(durationHrs - 1, 1) * 2.5;
    if (durationHrs > 2) pts += (durationHrs - 2) * 1.25;
    return round2(pts * 2); // always OB doubled
  }

  const addOnPts = calcAddOnPoints(caseData);
  const baseUnits = parseFloat(caseData.baseUnits) || 0;
  const basePoints = 0.5 * baseUnits;
  let caseStartMin = timeToMinutes(caseData.startTime);
  let caseEndMin = timeToMinutes(caseData.endTime);
  if (caseEndMin <= caseStartMin) caseEndMin += 1440;
  const caseMinutes = caseEndMin - caseStartMin;
  const caseHours = caseMinutes / 60;
  const isHol = shift ? shift.isHoliday : false;
  const isWknd = shift ? isWeekend(shift.date) : false;
  const timeMultiplier = getTimeMultiplier(caseData.physicalStatus, isHol, isWknd, caseStartMin, caseData.isHighRiskPeds);
  const adjustedHours = caseHours * timeMultiplier;
  const timePoints = adjustedHours * 6;
  const medicalPoints = caseData.isMedicalProc ? 0.20 * (parseFloat(caseData.medicalUnits) || 0) : 0;
  const acutePainPoints = caseData.isAcutePain ? 0.375 * (parseFloat(caseData.acutePainUnits) || 0) : 0;
  const emergencyPoints = caseData.isEmergency ? 1 : 0;
  let total = basePoints + timePoints + medicalPoints + acutePainPoints + emergencyPoints + addOnPts;
  const isOBShift = shift && ['OB_restricted','SF1','SF2'].includes(shift.assignmentType);
  if (isOBShift && !caseData.isORCase) total *= 2;
  return round2(total);
}

function getCaseBreakdown(caseData, shift) {
  const ct = caseData.caseType;
  const bd = [];
  if (ct === 'epidural_blood_patch') { bd.push({label:'Epidural Blood Patch', pts:5}); return bd; }
  if (ct === 'emergency_intubation') { bd.push({label:'Emergency Intubation', pts:4}); return bd; }
  if (ct === '01996') { bd.push({label:'Epidural Rounding (01996)', pts:3}); return bd; }
  if (ct === '99231') { bd.push({label:'Pain Rounding (99231)', pts:2}); return bd; }
  if (ct === 'tee') { bd.push({label:'TEE Exam', pts:22}); return bd; }

  if (ct === 'aps_rounding') {
    const epiN = parseInt(caseData.epiduralRounds) || 0;
    const painN = parseInt(caseData.painRounds) || 0;
    if (epiN > 0) bd.push({label: `Epidural Rounds (${epiN} x 3)`, pts: round2(epiN * 3)});
    if (painN > 0) bd.push({label: `Pain Rounds (${painN} x 2)`, pts: round2(painN * 2)});
    return bd;
  }

  if (ct === 'labor_epidural') {
    let cs = timeToMinutes(caseData.startTime);
    let ce = timeToMinutes(caseData.endTime);
    if (ce <= cs) ce += 1440;
    const durationHrs = Math.min((ce - cs) / 60, 24);
    let subtotal = 0;
    if (durationHrs > 0) {
      const p = round2(Math.min(durationHrs, 1) * 7.5);
      bd.push({label: `1st Hour (${round2(Math.min(durationHrs, 1))}h x 7.5)`, pts: p});
      subtotal += p;
    }
    if (durationHrs > 1) {
      const p = round2(Math.min(durationHrs - 1, 1) * 2.5);
      bd.push({label: `2nd Hour (${round2(Math.min(durationHrs - 1, 1))}h x 2.5)`, pts: p});
      subtotal += p;
    }
    if (durationHrs > 2) {
      const hrs = round2(durationHrs - 2);
      const p = round2(hrs * 1.25);
      bd.push({label: `Additional (${hrs}h x 1.25)`, pts: p});
      subtotal += p;
    }
    bd.push({label: 'OB Doubled (x2)', pts: round2(subtotal)});
    return bd;
  }

  const baseUnits = parseFloat(caseData.baseUnits) || 0;
  bd.push({label: `Half Base Units (${baseUnits} x 0.5)`, pts: round2(0.5 * baseUnits)});
  let caseStartMin = timeToMinutes(caseData.startTime);
  let caseEndMin = timeToMinutes(caseData.endTime);
  if (caseEndMin <= caseStartMin) caseEndMin += 1440;
  const caseMinutes = caseEndMin - caseStartMin;
  const caseHours = round2(caseMinutes / 60);
  const isHol = shift ? shift.isHoliday : false;
  const isWknd = shift ? isWeekend(shift.date) : false;
  const tm = getTimeMultiplier(caseData.physicalStatus, isHol, isWknd, caseStartMin, caseData.isHighRiskPeds);
  const adjustedHours = round2(caseHours * tm);
  const timePoints = round2(adjustedHours * 6);
  let tl = `Time (${caseHours}h x 6 pts/hr`;
  if (tm > 1) tl += ` x ${tm}`;
  tl += ')';
  bd.push({label: tl, pts: timePoints});
  if (caseData.isMedicalProc) {
    const mu = parseFloat(caseData.medicalUnits) || 0;
    bd.push({label: `Medical Proc (20% x ${mu})`, pts: round2(0.20 * mu)});
  }
  if (caseData.isAcutePain) {
    const au = parseFloat(caseData.acutePainUnits) || 0;
    bd.push({label: `Acute Pain (37.5% x ${au})`, pts: round2(0.375 * au)});
  }
  if (caseData.isEmergency) bd.push({label: 'Emergency', pts: 1});
  if (caseData.nerveBlock === 'brachial_plexus') bd.push({label: 'Nerve Block (Brachial Plexus)', pts: 3});
  else if (caseData.nerveBlock === 'other') bd.push({label: 'Nerve Block (Other)', pts: 2.6});
  if (caseData.hasCentralLine) bd.push({label: 'Central Line', pts: 0.8});
  if (caseData.hasArterialLine) bd.push({label: 'Arterial Line', pts: 0.6});
  if (caseData.hasPAC) bd.push({label: 'PAC', pts: 2});
  if (caseData.hasTEEAddOn) bd.push({label: 'TEE', pts: 0.4});
  const isOBShift = shift && ['OB_restricted','SF1','SF2'].includes(shift.assignmentType);
  if (isOBShift && !caseData.isORCase) {
    const subtotal = bd.reduce((s,r) => s + r.pts, 0);
    bd.push({label: 'OB Doubled (x2)', pts: round2(subtotal)});
  }
  return bd;
}

function calcSupervisionPoints(shift) {
  // Standalone CRNA_supervision type: sum clocked-in time from entries
  if (shift.assignmentType === 'CRNA_supervision') {
    const entries = shift.timeEntries || [];
    let totalMinutes = 0;
    entries.forEach(e => {
      if (!e.start || !e.end) return;
      let s = timeToMinutes(e.start);
      let en = timeToMinutes(e.end);
      if (en <= s) en += 1440;
      totalMinutes += (en - s);
    });
    if (totalMinutes === 0 && shift.endTime) {
      let startMin = timeToMinutes(shift.startTime);
      let endMin = timeToMinutes(shift.endTime);
      if (endMin <= startMin) endMin += 1440;
      totalMinutes = endMin - startMin;
    }
    return round2(totalMinutes / 60 * 7);
  }
  // Overlay on OR/SF1/SF2
  if (shift.supervisionStart && shift.supervisionEnd) {
    let startMin = timeToMinutes(shift.supervisionStart);
    let endMin = timeToMinutes(shift.supervisionEnd);
    if (endMin <= startMin) endMin += 1440;
    return round2((endMin - startMin) / 60 * 7);
  }
  return 0;
}

function calcCallPoints(shift) {
  // Unrestricted call is now automatically calculated inside calcARPoints via gap detection
  return 0;
}

function calcSubspecPoints(shift) {
  let pts = 0;
  if (shift.subspecCoverage) pts += 45;
  pts += (parseInt(shift.teeCount) || 0) * 22;
  return pts;
}

function calcShiftTotal(shift) {
  const shiftCases = data.cases.filter(c => c.shiftDate === shift.date);
  const breakdown = calcARBreakdown(shift);
  const arPts = breakdown.ar;
  const callPts = breakdown.call;
  let prodPts = 0;
  if (shift.assignmentType !== 'CRNA_supervision') {
    shiftCases.forEach(c => { prodPts += calcCasePoints(c, shift); });
  }
  const subspecPts = (shift.assignmentType === 'cardiac_liver') ? calcSubspecPoints(shift) : 0;
  const supervisionPts = calcSupervisionPoints(shift);
  return { ar: arPts, prod: round2(prodPts), call: callPts, subspec: subspecPts, supervision: supervisionPts, total: round2(arPts + prodPts + callPts + subspecPts + supervisionPts) };
}

function getCaseTypeName(type) {
  const names = {
    standard: 'Standard Case', labor_epidural: 'Labor Epidural',
    aps_rounding: 'APS Rounding', epidural_blood_patch: 'Epidural Blood Patch',
    emergency_intubation: 'Emergency Intubation', '01996': 'Epidural Rounding (01996)',
    '99231': 'Pain Rounding (99231)', tee: 'TEE Exam'
  };
  return names[type] || type;
}

// ================================================================
// WORKING DATE
// ================================================================
let workingDate = todayStr();

function setWorkingDate(d) {
  workingDate = d;
  document.getElementById('shiftDate').value = d;
  document.getElementById('headerDateBtn').textContent = formatDateShort(d);
  loadShiftForDate();
  updateHeaderPoints();
  updateEndTimeWarning();
  updateORCaseVisibility();
}

// Header date picker
document.getElementById('headerDateBtn').addEventListener('click', () => {
  document.getElementById('globalDatePicker').value = workingDate;
  document.getElementById('datePickerModal').classList.remove('hidden');
});

document.getElementById('cancelDatePicker').addEventListener('click', () => {
  document.getElementById('datePickerModal').classList.add('hidden');
});

document.getElementById('applyDatePicker').addEventListener('click', () => {
  const v = document.getElementById('globalDatePicker').value;
  if (v) setWorkingDate(v);
  document.getElementById('datePickerModal').classList.add('hidden');
});

document.getElementById('datePickerModal').addEventListener('click', (e) => {
  if (e.target.id === 'datePickerModal') document.getElementById('datePickerModal').classList.add('hidden');
});

// ================================================================
// NAVIGATION (bottom nav)
// ================================================================
document.querySelectorAll('.bottom-nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('page-' + btn.dataset.page).classList.add('active');
    if (btn.dataset.page === 'shift') loadShiftForDate();
    if (btn.dataset.page === 'today') renderToday();
    if (btn.dataset.page === 'cases') updateORCaseVisibility();
    if (btn.dataset.page === 'dashboard') switchDashboardTab(activeDashTab);
    if (btn.dataset.page === 'settings') renderHistory();
    if (btn.dataset.page === 'reconcile') renderReconTabs();
  });
});

// ================================================================
// SHIFT TEMPLATES
// ================================================================
const defaultTemplates = [
  { name: 'OR Day', type: 'OR', start: '07:10', end: '17:00' },
  { name: 'UVH OB Day', type: 'OB_restricted', start: '07:00', end: '19:00' },
  { name: 'UVH OB Night', type: 'OB_restricted', start: '19:00', end: '07:00' },
  { name: 'UVH OB Weekend', type: 'OB_restricted', start: '07:00', end: '07:00' },
  { name: 'NORA', type: 'NORA', start: '07:00', end: '14:00' },
  { name: 'ACS', type: 'ACS', start: '07:00', end: '17:00' },
];

function renderTemplates() {
  const grid = document.getElementById('templateGrid');
  const templates = defaultTemplates;
  grid.innerHTML = templates.map((t, i) => `
    <button class="template-btn" data-tidx="${i}">
      <span class="t-label">${t.name}</span>
      <span class="t-time">${t.start} - ${t.end}</span>
    </button>
  `).join('');

  grid.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const t = templates[parseInt(btn.dataset.tidx)];
      document.getElementById('shiftAssignmentType').value = t.type;
      populateTimeEntries([{ start: t.start, end: t.end }]);
      document.getElementById('cardiacLiverOptions').classList.toggle('hidden', t.type !== 'cardiac_liver');
      updateSupervisionOverlayVisibility();
      showToast('Template applied');
    });
  });
}

// Template collapse toggle
document.getElementById('templateCollapseHeader').addEventListener('click', () => {
  const body = document.getElementById('templateCollapseBody');
  const arrow = document.getElementById('templateArrow');
  if (body.style.maxHeight && body.style.maxHeight !== '0px') {
    body.style.maxHeight = '0';
    arrow.classList.remove('open');
  } else {
    body.style.maxHeight = body.scrollHeight + 'px';
    arrow.classList.add('open');
  }
});

// Quick Procedures collapse toggle
document.getElementById('quickProcCollapseHeader').addEventListener('click', () => {
  const body = document.getElementById('quickProcCollapseBody');
  const arrow = document.getElementById('quickProcArrow');
  if (body.style.maxHeight && body.style.maxHeight !== '0px') {
    body.style.maxHeight = '0';
    arrow.classList.remove('open');
  } else {
    body.style.maxHeight = body.scrollHeight + 'px';
    arrow.classList.add('open');
  }
});

// Quick Procedure button clicks
const quickProcs = {
  colonoscopy: { name: 'Colonoscopy', units: 4 },
  egd: { name: 'EGD', units: 5 },
  double: { name: 'EGD + Colonoscopy', units: 5 },
  tonsils: { name: 'Tonsillectomy', units: 5 }
};

document.querySelectorAll('[data-qproc]').forEach(btn => {
  btn.addEventListener('click', () => {
    const proc = quickProcs[btn.dataset.qproc];
    if (!proc) return;
    selectedCaseType = 'standard';
    document.querySelectorAll('#page-cases .case-type-btn').forEach(b => b.classList.toggle('selected', b.dataset.case === 'standard'));
    document.getElementById('standardFields').classList.remove('hidden');
    document.getElementById('laborEpiduralFields').classList.add('hidden');
    document.getElementById('apsRoundingFields').classList.add('hidden');
    document.getElementById('simpleFields').classList.add('hidden');
    document.getElementById('caseProcedure').value = proc.name;
    document.getElementById('caseBaseUnits').value = proc.units;
    updatePointPreview();
    showToast(proc.name + ' pre-filled');
  });
});

// ================================================================
// SHIFT PAGE
// ================================================================
const shiftDateInput = document.getElementById('shiftDate');

function updateUnrestrictedCallVisibility() {
  // Unrestricted call is now automatic based on shift type + gaps — no manual UI needed
}

function updateEndTimeWarning() {
  const shift = data.shifts[workingDate];
  const banner = document.getElementById('endTimeWarning');
  const hasNoEnd = shift && !shift.forcedOff && shift.timeEntries &&
    shift.timeEntries.length > 0 && !shift.timeEntries[shift.timeEntries.length - 1].end;
  if (hasNoEnd) {
    banner.classList.remove('hidden');
  } else {
    banner.classList.add('hidden');
  }
}

function updateORCaseVisibility() {
  const shift = data.shifts[workingDate];
  const isSF = shift && ['SF1','SF2'].includes(shift.assignmentType);
  document.getElementById('orCaseRow').classList.toggle('hidden', !isSF);
  if (!isSF) document.getElementById('caseORCase').checked = false;
}

function updateSupervisionOverlayVisibility() {
  const type = getSelectedAssignmentType();
  const eligible = ['OR','SF1','SF2'].includes(type);
  document.getElementById('supervisionOverlaySection').classList.toggle('hidden', !eligible);
  if (!eligible) {
    document.getElementById('supervisionOverlayCheck').checked = false;
    document.getElementById('supervisionTimes').classList.add('hidden');
  }
}

function checkEndTimeNotification() {
  const now = new Date();
  if (now.getHours() < 7) return;
  const twoDaysAgo = new Date(now.getTime() - 48 * 60 * 60 * 1000);
  const missing = Object.values(data.shifts).filter(s => {
    if (s.forcedOff) return false;
    // Check if last entry has an end time
    const entries = s.timeEntries || [];
    const lastEnd = entries.length > 0 ? entries[entries.length - 1].end : s.endTime;
    if (lastEnd) return false;
    const sd = new Date(s.date + 'T12:00:00');
    return sd >= twoDaysAgo && sd <= now;
  });
  if (missing.length === 0) return;
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  if ('Notification' in window && Notification.permission === 'granted') {
    const dates = missing.map(s => formatDateShort(s.date)).join(', ');
    new Notification('MWA Point Tracker', {
      body: `Missing end time for: ${dates}`,
      icon: 'icons/icon-192.png'
    });
  }
}

document.getElementById('shiftAssignmentType').addEventListener('change', function() {
  const type = this.value;
  document.getElementById('cardiacLiverOptions').classList.toggle('hidden', type !== 'cardiac_liver');
  updateUnrestrictedCallVisibility();
  updateSupervisionOverlayVisibility();
  updateORCaseVisibility();
});

document.getElementById('supervisionOverlayCheck').addEventListener('change', function() {
  document.getElementById('supervisionTimes').classList.toggle('hidden', !this.checked);
});

shiftDateInput.addEventListener('change', function() {
  workingDate = this.value;
  document.getElementById('headerDateBtn').textContent = formatDateShort(workingDate);
  loadShiftForDate();
});

function getSelectedAssignmentType() {
  return document.getElementById('shiftAssignmentType').value || 'OR';
}

function loadShiftForDate() {
  const date = workingDate;
  const shift = data.shifts[date];
  const banner = document.getElementById('editShiftBanner');
  if (shift) {
    banner.textContent = 'Editing shift for ' + formatDate(date);
    banner.classList.remove('hidden');
    document.getElementById('shiftAssignmentType').value = shift.assignmentType;
    populateTimeEntries(shift.timeEntries || [{ start: shift.startTime || '07:00', end: shift.endTime || '' }]);
    document.getElementById('shiftHoliday').checked = shift.isHoliday || false;
    document.getElementById('shiftForcedOff').checked = shift.forcedOff || false;
    document.getElementById('cardiacLiverOptions').classList.toggle('hidden', shift.assignmentType !== 'cardiac_liver');
    document.getElementById('subspecCoverage').checked = shift.subspecCoverage || false;
    document.getElementById('teeCount').value = shift.teeCount || 0;
    if (shift.supervisionStart || shift.supervisionEnd) {
      document.getElementById('supervisionOverlayCheck').checked = true;
      document.getElementById('supervisionStart').value = shift.supervisionStart || '';
      document.getElementById('supervisionEnd').value = shift.supervisionEnd || '';
      document.getElementById('supervisionTimes').classList.remove('hidden');
    } else {
      document.getElementById('supervisionOverlayCheck').checked = false;
      document.getElementById('supervisionStart').value = '';
      document.getElementById('supervisionEnd').value = '';
      document.getElementById('supervisionTimes').classList.add('hidden');
    }
  } else {
    banner.classList.add('hidden');
    document.getElementById('shiftAssignmentType').value = 'OR';
    populateTimeEntries([{ start: '07:00', end: '' }]);
    document.getElementById('shiftHoliday').checked = false;
    document.getElementById('shiftForcedOff').checked = false;
    document.getElementById('cardiacLiverOptions').classList.add('hidden');
    document.getElementById('subspecCoverage').checked = false;
    document.getElementById('teeCount').value = 0;
    document.getElementById('supervisionOverlayCheck').checked = false;
    document.getElementById('supervisionStart').value = '';
    document.getElementById('supervisionEnd').value = '';
    document.getElementById('supervisionTimes').classList.add('hidden');
  }
  updateUnrestrictedCallVisibility();
  updateSupervisionOverlayVisibility();
  updateEndTimeWarning();
}

document.getElementById('saveShiftBtn').addEventListener('click', () => {
  const date = workingDate;
  if (!date) { showToast('Please select a date'); return; }
  const supervisionEnabled = document.getElementById('supervisionOverlayCheck')?.checked || false;
  const timeEntries = collectTimeEntries();
  if (timeEntries.length === 0 || !timeEntries[0].start) {
    showToast('Please enter at least one start time');
    return;
  }
  // Validate: entries should be in chronological order, no overlaps
  for (let i = 1; i < timeEntries.length; i++) {
    const prevEnd = timeToMinutes(timeEntries[i-1].end);
    const currStart = timeToMinutes(timeEntries[i].start);
    if (timeEntries[i-1].end && currStart <= prevEnd) {
      showToast('Time entries must be in chronological order with no overlaps');
      return;
    }
  }
  data.shifts[date] = {
    date, assignmentType: getSelectedAssignmentType(),
    startTime: timeEntries[0].start,
    endTime: timeEntries[timeEntries.length - 1].end || '',
    timeEntries: timeEntries,
    isHoliday: document.getElementById('shiftHoliday').checked,
    forcedOff: document.getElementById('shiftForcedOff').checked,
    subspecCoverage: document.getElementById('subspecCoverage').checked,
    teeCount: parseInt(document.getElementById('teeCount').value) || 0,
    supervisionStart: supervisionEnabled ? document.getElementById('supervisionStart').value : '',
    supervisionEnd: supervisionEnabled ? document.getElementById('supervisionEnd').value : ''
  };
  saveData(data);
  updateHeaderPoints();
  updateEndTimeWarning();
  updateORCaseVisibility();
  showToast('Shift saved!');
});

// ================================================================
// CASE PAGE
// ================================================================
let selectedCaseType = 'standard';

document.querySelectorAll('#page-cases .case-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#page-cases .case-type-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedCaseType = btn.dataset.case;
    const isStd = selectedCaseType === 'standard';
    const isLabor = selectedCaseType === 'labor_epidural';
    const isAPS = selectedCaseType === 'aps_rounding';
    document.getElementById('standardFields').classList.toggle('hidden', !isStd);
    document.getElementById('laborEpiduralFields').classList.toggle('hidden', !isLabor);
    document.getElementById('apsRoundingFields').classList.toggle('hidden', !isAPS);
    document.getElementById('simpleFields').classList.toggle('hidden', isStd || isLabor || isAPS);
    updatePointPreview();
  });
});

document.getElementById('caseMedicalProc').addEventListener('change', function() {
  document.getElementById('medicalUnitsRow').classList.toggle('hidden', !this.checked);
  updatePointPreview();
});

document.getElementById('caseAcutePain').addEventListener('change', function() {
  document.getElementById('acutePainUnitsRow').classList.toggle('hidden', !this.checked);
  updatePointPreview();
});

['caseBaseUnits','caseStart','caseEnd','casePhysicalStatus','caseMedicalUnits','caseAcutePainUnits','laborStart','laborEnd','caseNerveBlock','apsEpiduralCount','apsPainCount'].forEach(id => {
  const el = document.getElementById(id);
  if (el) { el.addEventListener('input', updatePointPreview); el.addEventListener('change', updatePointPreview); }
});

['caseEmergency','caseHighRiskPeds','caseMedicalProc','caseAcutePain','caseORCase','caseCentralLine','caseArterialLine','casePAC','caseTEEAddOn'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', updatePointPreview);
});

function updatePointPreview() {
  const previewEl = document.getElementById('casePointPreview');
  const previewPts = document.getElementById('previewPoints');
  const tempCase = buildCaseFromForm();
  const shift = data.shifts[workingDate] || { date: workingDate, assignmentType: 'OR', isHoliday: false };
  const pts = calcCasePoints(tempCase, shift);
  previewEl.classList.remove('hidden');
  previewPts.textContent = pts.toFixed(2) + ' pts';
}

function buildCaseFromForm() {
  const isLabor = selectedCaseType === 'labor_epidural';
  const isAPS = selectedCaseType === 'aps_rounding';
  return {
    caseType: selectedCaseType,
    procedure: isLabor ? 'Labor Epidural' : (isAPS ? 'APS Rounding' : (document.getElementById('caseProcedure')?.value || selectedCaseType)),
    baseUnits: document.getElementById('caseBaseUnits')?.value || 0,
    physicalStatus: document.getElementById('casePhysicalStatus')?.value || 'P3',
    startTime: isLabor ? (document.getElementById('laborStart')?.value || '') : (document.getElementById('caseStart')?.value || ''),
    endTime: isLabor ? (document.getElementById('laborEnd')?.value || '') : (document.getElementById('caseEnd')?.value || ''),
    isEmergency: document.getElementById('caseEmergency')?.checked || false,
    isMedicalProc: document.getElementById('caseMedicalProc')?.checked || false,
    medicalUnits: document.getElementById('caseMedicalUnits')?.value || 0,
    isAcutePain: document.getElementById('caseAcutePain')?.checked || false,
    acutePainUnits: document.getElementById('caseAcutePainUnits')?.value || 0,
    isHighRiskPeds: document.getElementById('caseHighRiskPeds')?.checked || false,
    isORCase: document.getElementById('caseORCase')?.checked || false,
    nerveBlock: document.getElementById('caseNerveBlock')?.value || 'none',
    hasCentralLine: document.getElementById('caseCentralLine')?.checked || false,
    hasArterialLine: document.getElementById('caseArterialLine')?.checked || false,
    hasPAC: document.getElementById('casePAC')?.checked || false,
    hasTEEAddOn: document.getElementById('caseTEEAddOn')?.checked || false,
    epiduralRounds: document.getElementById('apsEpiduralCount')?.value || 0,
    painRounds: document.getElementById('apsPainCount')?.value || 0,
    notes: document.getElementById('caseNotes')?.value || ''
  };
}

document.getElementById('saveCaseBtn').addEventListener('click', () => {
  const date = workingDate;
  if (!date) { showToast('Set shift date first'); return; }
  if (!data.shifts[date]) { showToast('Please save a shift for this date first'); return; }
  if (data.shifts[date].assignmentType === 'CRNA_supervision') { showToast('CRNA Supervision shifts do not have cases'); return; }
  const caseData = buildCaseFromForm();
  caseData.id = genId();
  caseData.shiftDate = date;
  caseData.timestamp = new Date().toISOString();
  if (caseData.caseType === 'standard' || caseData.caseType === 'labor_epidural') {
    if (!caseData.startTime || !caseData.endTime) { showToast('Please enter start and end times'); return; }
  }
  if (caseData.caseType === 'aps_rounding') {
    if (!(parseInt(caseData.epiduralRounds) > 0) && !(parseInt(caseData.painRounds) > 0)) { showToast('Enter at least one round count'); return; }
  }
  data.cases.push(caseData);
  saveData(data);
  updateHeaderPoints();
  showToast('Case saved! (' + calcCasePoints(caseData, data.shifts[date]).toFixed(2) + ' pts)');
  resetCaseForm();
});

function resetCaseForm() {
  document.getElementById('caseProcedure').value = '';
  document.getElementById('caseBaseUnits').value = '0';
  document.getElementById('casePhysicalStatus').value = 'P3';
  document.getElementById('caseStart').value = '';
  document.getElementById('caseEnd').value = '';
  document.getElementById('caseEmergency').checked = false;
  document.getElementById('caseMedicalProc').checked = false;
  document.getElementById('caseMedicalUnits').value = '0';
  document.getElementById('medicalUnitsRow').classList.add('hidden');
  document.getElementById('caseAcutePain').checked = false;
  document.getElementById('caseAcutePainUnits').value = '0';
  document.getElementById('acutePainUnitsRow').classList.add('hidden');
  document.getElementById('caseHighRiskPeds').checked = false;
  document.getElementById('caseORCase').checked = false;
  document.getElementById('caseNerveBlock').value = 'none';
  document.getElementById('caseCentralLine').checked = false;
  document.getElementById('caseArterialLine').checked = false;
  document.getElementById('casePAC').checked = false;
  document.getElementById('caseTEEAddOn').checked = false;
  document.getElementById('laborStart').value = '';
  document.getElementById('laborEnd').value = '';
  document.getElementById('laborEpiduralFields').classList.add('hidden');
  document.getElementById('apsEpiduralCount').value = '0';
  document.getElementById('apsPainCount').value = '0';
  document.getElementById('apsRoundingFields').classList.add('hidden');
  document.getElementById('caseNotes').value = '';
  document.getElementById('simpleNotes').value = '';
  document.getElementById('casePointPreview').classList.add('hidden');
}

// ================================================================
// TODAY PAGE
// ================================================================
function renderToday() {
  const date = workingDate;
  const shift = data.shifts[date];
  const shiftCases = data.cases.filter(c => c.shiftDate === date);
  document.getElementById('todayTitle').textContent = date === todayStr() ? "Today's Summary" : formatDate(date);

  if (!shift) {
    document.getElementById('todayAR').textContent = '0';
    document.getElementById('todayProd').textContent = '0';
    document.getElementById('todayCall').textContent = '0';
    document.getElementById('todayTotal').textContent = '0';
    document.getElementById('todayBreakdown').innerHTML = '<p style="color:var(--text-dim);font-size:0.85rem;">No shift saved for this date.</p>';
    document.getElementById('todayCaseList').innerHTML = '<div class="empty-state"><p>No cases logged yet.</p></div>';
    document.getElementById('todayCaseCount').textContent = '';
    return;
  }

  const totals = calcShiftTotal(shift);
  document.getElementById('todayAR').textContent = totals.ar.toFixed(1);
  document.getElementById('todayProd').textContent = totals.prod.toFixed(1);
  document.getElementById('todayCall').textContent = (totals.call + totals.subspec + totals.supervision).toFixed(1);
  document.getElementById('todayTotal').textContent = totals.total.toFixed(1);

  let bdHtml = '<div class="point-breakdown">';
  // Show time entries
  const entries = shift.timeEntries || [{ start: shift.startTime, end: shift.endTime }];
  if (entries.length > 1) {
    const isWkndOrHol = shift.isHoliday || isWeekend(shift.date);
    bdHtml += `<div class="row" style="font-size:0.75rem;color:var(--text-dim);border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:4px;"><span>Time Entries (${entries.length})</span><span></span></div>`;
    for (let i = 0; i < entries.length; i++) {
      bdHtml += `<div class="row" style="font-size:0.75rem;"><span>Clocked in: ${entries[i].start} - ${entries[i].end || '?'}</span><span></span></div>`;
      if (i < entries.length - 1 && entries[i].end && entries[i+1].start) {
        const gapEligible = isUnrestrictedCallEligible(shift.assignmentType, timeToMinutes(entries[i].end), isWkndOrHol);
        bdHtml += `<div class="row" style="font-size:0.75rem;color:${gapEligible ? 'var(--accent2)' : 'var(--text-dim)'}"><span>Gap: ${entries[i].end} - ${entries[i+1].start}${gapEligible ? ' (unrestricted)' : ''}</span><span></span></div>`;
      }
    }
  } else if (entries.length === 1) {
    bdHtml += `<div class="row" style="font-size:0.75rem;color:var(--text-dim);"><span>${entries[0].start} - ${entries[0].end || '?'}</span><span></span></div>`;
  }
  bdHtml += `<div class="row"><span>Availability Rate</span><span>${totals.ar.toFixed(2)}</span></div>`;
  bdHtml += `<div class="row"><span>Productivity (${shiftCases.length} cases)</span><span>${totals.prod.toFixed(2)}</span></div>`;
  if (totals.call > 0) bdHtml += `<div class="row"><span>Unrestricted Call (auto)</span><span>${totals.call.toFixed(2)}</span></div>`;
  if (totals.subspec > 0) bdHtml += `<div class="row"><span>Subspecialty</span><span>${totals.subspec.toFixed(2)}</span></div>`;
  if (totals.supervision > 0) bdHtml += `<div class="row"><span>CRNA Supervision</span><span>${totals.supervision.toFixed(2)}</span></div>`;
  bdHtml += `<div class="row total"><span>Total</span><span>${totals.total.toFixed(2)} pts</span></div>`;
  bdHtml += '</div>';
  document.getElementById('todayBreakdown').innerHTML = bdHtml;

  document.getElementById('todayCaseCount').textContent = `(${shiftCases.length})`;

  if (shiftCases.length === 0) {
    document.getElementById('todayCaseList').innerHTML = '<div class="empty-state"><p>No cases logged yet.</p></div>';
    return;
  }

  let listHtml = '';
  shiftCases.forEach(c => {
    const pts = calcCasePoints(c, shift);
    const name = c.caseType === 'standard' ? (c.procedure || 'Standard Case') : getCaseTypeName(c.caseType);
    const orTag = c.isORCase ? ' <span style="color:var(--accent2);font-size:0.75rem;">[OR]</span>' : '';
    const timeStr = c.startTime && c.endTime ? `${c.startTime} - ${c.endTime}` : '';
    const details = [];
    if (c.physicalStatus && c.caseType === 'standard') details.push(c.physicalStatus);
    if (c.baseUnits && c.caseType === 'standard') details.push(`${c.baseUnits} base`);
    if (timeStr) details.push(timeStr);
    if (c.caseType === 'aps_rounding') {
      const epi = parseInt(c.epiduralRounds) || 0;
      const pain = parseInt(c.painRounds) || 0;
      if (epi > 0) details.push(`${epi} epi`);
      if (pain > 0) details.push(`${pain} pain`);
    }
    listHtml += `
      <div class="case-list-item">
        <div class="info">
          <h4>${escHtml(name)}${orTag}</h4>
          <p>${escHtml(details.join(' | '))}</p>
          ${c.notes ? `<p style="margin-top:2px;font-style:italic;">${escHtml(c.notes)}</p>` : ''}
        </div>
        <div class="actions">
          <span class="point-badge">${pts.toFixed(1)} pts</span>
          <button class="btn btn-danger btn-sm" onclick="deleteCase('${c.id}')">Del</button>
        </div>
      </div>`;
  });
  document.getElementById('todayCaseList').innerHTML = listHtml;
}

function escHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function deleteCase(id) {
  if (!confirm('Delete this case?')) return;
  data.cases = data.cases.filter(c => c.id !== id);
  saveData(data);
  updateHeaderPoints();
  renderToday();
  showToast('Case deleted');
}

// ================================================================
// HISTORY (in More page)
// ================================================================
let historyYear = new Date().getFullYear();
let historyMonth = new Date().getMonth();

function renderHistory() {
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('historyMonth').textContent = `${monthNames[historyMonth]} ${historyYear}`;
  const prefix = `${historyYear}-${String(historyMonth+1).padStart(2,'0')}`;
  const monthShifts = Object.values(data.shifts).filter(s => s.date.startsWith(prefix)).sort((a,b) => b.date.localeCompare(a.date));
  let monthTotalPts = 0;
  let listHtml = '';
  monthShifts.forEach(shift => {
    const totals = calcShiftTotal(shift);
    monthTotalPts += totals.total;
    const caseCount = data.cases.filter(c => c.shiftDate === shift.date).length;
    const entries = shift.timeEntries || [{ start: shift.startTime, end: shift.endTime }];
    const timeStr = entries.map(e => `${e.start}-${e.end || '?'}`).join(', ');
    listHtml += `
      <div class="day-list-item" onclick="showDayDetail('${shift.date}')">
        <div>
          <div class="date">${formatDate(shift.date)}</div>
          <div class="meta">${getAssignmentTypeName(shift.assignmentType)} | ${timeStr} | ${caseCount} cases</div>
        </div>
        <span class="point-badge large">${totals.total.toFixed(1)}</span>
      </div>`;
  });
  document.getElementById('monthTotal').textContent = monthTotalPts.toFixed(1);
  document.getElementById('monthDays').textContent = monthShifts.length;
  document.getElementById('historyList').innerHTML = monthShifts.length === 0
    ? '<div class="empty-state"><p>No shifts recorded for this month.</p></div>'
    : listHtml;
}

document.getElementById('prevMonth').addEventListener('click', () => {
  historyMonth--;
  if (historyMonth < 0) { historyMonth = 11; historyYear--; }
  renderHistory();
});

document.getElementById('nextMonth').addEventListener('click', () => {
  historyMonth++;
  if (historyMonth > 11) { historyMonth = 0; historyYear++; }
  renderHistory();
});

function showDayDetail(dateStr) {
  const shift = data.shifts[dateStr];
  if (!shift) return;
  const totals = calcShiftTotal(shift);
  const shiftCases = data.cases.filter(c => c.shiftDate === dateStr);
  document.getElementById('dayModalTitle').textContent = formatDate(dateStr);
  const detailEntries = shift.timeEntries || [{ start: shift.startTime, end: shift.endTime }];
  const detailTimeStr = detailEntries.map(e => `${e.start}-${e.end || '?'}`).join(', ');
  let html = `
    <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:8px;">${getAssignmentTypeName(shift.assignmentType)} | ${detailTimeStr}${detailEntries.length > 1 ? ' (' + detailEntries.length + ' entries)' : ''}</p>
    <div class="summary-grid" style="margin-bottom:12px;">
      <div class="summary-item"><div class="label">AR</div><div class="value blue">${totals.ar.toFixed(1)}</div></div>
      <div class="summary-item"><div class="label">Prod</div><div class="value green">${totals.prod.toFixed(1)}</div></div>
      <div class="summary-item"><div class="label">Call/Other</div><div class="value yellow">${(totals.call + totals.subspec + totals.supervision).toFixed(1)}</div></div>
      <div class="summary-item"><div class="label">Total</div><div class="value">${totals.total.toFixed(1)}</div></div>
    </div>
    <h3 style="margin-bottom:8px;">Cases (${shiftCases.length})</h3>`;
  shiftCases.forEach(c => {
    const pts = calcCasePoints(c, shift);
    const name = c.caseType === 'standard' ? (c.procedure || 'Standard Case') : getCaseTypeName(c.caseType);
    const breakdown = getCaseBreakdown(c, shift);
    html += `<div style="padding:8px 0;border-bottom:1px solid var(--surface2);">
      <div style="display:flex;justify-content:space-between;"><strong>${escHtml(name)}</strong><span class="point-badge">${pts.toFixed(1)}</span></div>`;
    breakdown.forEach(r => {
      html += `<div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-dim);padding:2px 0;"><span>${escHtml(r.label)}</span><span>${r.pts.toFixed(2)}</span></div>`;
    });
    if (c.notes) html += `<div style="font-size:0.75rem;color:var(--text-dim);font-style:italic;margin-top:2px;">${escHtml(c.notes)}</div>`;
    html += '</div>';
  });
  document.getElementById('dayModalContent').innerHTML = html;
  document.getElementById('dayModal').classList.remove('hidden');
}

document.getElementById('closeDayModal').addEventListener('click', () => { document.getElementById('dayModal').classList.add('hidden'); });
document.getElementById('dayModal').addEventListener('click', (e) => {
  if (e.target.id === 'dayModal') document.getElementById('dayModal').classList.add('hidden');
});

// ================================================================
// DASHBOARD — Tabs & Rendering
// ================================================================
let monthlyChart = null;
let breakdownChart = null;
let productionTrendChart = null;
let shiftDistChart = null;
let activeDashTab = 'caselogs';

// Dashboard sub-tab switching
document.querySelectorAll('.dash-tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchDashboardTab(btn.dataset.dtab));
});

function switchDashboardTab(tabName) {
  activeDashTab = tabName;
  document.querySelectorAll('.dash-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.dtab === tabName));
  document.getElementById('dtab-caselogs').classList.toggle('hidden', tabName !== 'caselogs');
  document.getElementById('dtab-projections').classList.toggle('hidden', tabName !== 'projections');
  document.getElementById('dtab-time').classList.toggle('hidden', tabName !== 'time');
  document.getElementById('dtab-analytics').classList.toggle('hidden', tabName !== 'analytics');
  if (tabName === 'caselogs') renderCaseLogTable();
  if (tabName === 'projections') renderProjections();
  if (tabName === 'time') renderTimeTab();
  if (tabName === 'analytics') renderAnalyticsTab();
}

// Generic collapsible toggle
function toggleCollapse(sectionId) {
  const bodyMap = {
    projBreakdown: 'projBreakdownBody', projEfficiency: 'projEfficiencyBody', projMoM: 'projMoMBody',
    timeDOW: 'timeDOWBody', timeWknd: 'timeWkndBody', timeNight: 'timeNightBody',
    analAddOns: 'analAddOnsBody', analTopProc: 'analTopProcBody', analAvgUnits: 'analAvgUnitsBody',
    analShiftDist: 'analShiftDistBody'
  };
  const arrowMap = {
    projBreakdown: 'projBreakdownArrow', projEfficiency: 'projEfficiencyArrow', projMoM: 'projMoMArrow',
    timeDOW: 'timeDOWArrow', timeWknd: 'timeWkndArrow', timeNight: 'timeNightArrow',
    analAddOns: 'analAddOnsArrow', analTopProc: 'analTopProcArrow', analAvgUnits: 'analAvgUnitsArrow',
    analShiftDist: 'analShiftDistArrow'
  };
  const body = document.getElementById(bodyMap[sectionId]);
  const arrow = document.getElementById(arrowMap[sectionId]);
  if (!body || !arrow) return;
  if (body.style.maxHeight && body.style.maxHeight !== '0px') {
    body.style.maxHeight = '0';
    arrow.classList.remove('open');
  } else {
    body.style.maxHeight = body.scrollHeight + 'px';
    arrow.classList.add('open');
  }
}

// Shared helper: shift clocked-in hours (sum of time entries, not gaps)
function calcShiftHours(shift) {
  if (!shift) return 0;
  const entries = shift.timeEntries || [];
  if (entries.length > 0) {
    let totalMin = 0;
    entries.forEach(e => {
      if (!e.start || !e.end) return;
      let s = timeToMinutes(e.start);
      let en = timeToMinutes(e.end);
      if (en <= s) en += 1440;
      totalMin += (en - s);
    });
    if (totalMin > 0) return totalMin / 60;
  }
  // Fallback for legacy shifts without timeEntries
  if (!shift.endTime) return 0;
  let start = timeToMinutes(shift.startTime);
  let end = timeToMinutes(shift.endTime);
  if (end <= start) end += 1440;
  return (end - start) / 60;
}

// ================================================================
// CASE LOGS TAB
// ================================================================
let clYear = new Date().getFullYear();
let clMonth = new Date().getMonth();

function updateCLMonthLabel() {
  const mn = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('clMonthLabel').textContent = `${mn[clMonth]} ${clYear}`;
}

document.getElementById('clPrevMonth').addEventListener('click', () => {
  clMonth--; if (clMonth < 0) { clMonth = 11; clYear--; }
  updateCLMonthLabel(); renderCaseLogTable();
});
document.getElementById('clNextMonth').addEventListener('click', () => {
  clMonth++; if (clMonth > 11) { clMonth = 0; clYear++; }
  updateCLMonthLabel(); renderCaseLogTable();
});

document.getElementById('caseLogSearch').addEventListener('input', () => filterCaseLog());

function getCaseAddOnSummary(c) {
  const parts = [];
  if (c.nerveBlock === 'brachial_plexus') parts.push('NB-BP');
  else if (c.nerveBlock === 'other') parts.push('NB');
  if (c.hasCentralLine) parts.push('CL');
  if (c.hasArterialLine) parts.push('AL');
  if (c.hasPAC) parts.push('PAC');
  if (c.hasTEEAddOn) parts.push('TEE');
  return parts.join(', ');
}

function renderCaseLogTable() {
  updateCLMonthLabel();
  const prefix = `${clYear}-${String(clMonth+1).padStart(2,'0')}`;
  const monthCases = data.cases.filter(c => c.shiftDate && c.shiftDate.startsWith(prefix))
    .sort((a, b) => (b.shiftDate + (b.startTime || '')).localeCompare(a.shiftDate + (a.startTime || '')));
  const container = document.getElementById('caseLogTableContainer');
  if (monthCases.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>No cases for this month.</p></div>';
    return;
  }
  let html = '<table class="case-log-table" id="caseLogTable"><thead><tr>';
  html += '<th>Date</th><th>Procedure</th><th>Type</th><th>Start</th><th>End</th><th>Units</th><th>PS</th><th>E</th><th>Add-ons</th><th>Pts</th>';
  html += '</tr></thead><tbody>';
  monthCases.forEach(c => {
    const shift = data.shifts[c.shiftDate];
    const pts = calcCasePoints(c, shift);
    const name = c.caseType === 'standard' ? (c.procedure || 'Standard') : getCaseTypeName(c.caseType);
    const addOns = getCaseAddOnSummary(c);
    html += `<tr data-caseid="${c.id}" onclick="openCaseEdit('${c.id}')">`;
    html += `<td>${formatDateShort(c.shiftDate)}</td>`;
    html += `<td>${escHtml(name)}</td>`;
    html += `<td>${c.caseType === 'standard' ? 'Std' : (c.caseType === 'labor_epidural' ? 'LE' : (c.caseType === 'aps_rounding' ? 'APS' : c.caseType))}</td>`;
    html += `<td>${c.startTime || '-'}</td>`;
    html += `<td>${c.endTime || '-'}</td>`;
    html += `<td>${c.baseUnits || '-'}</td>`;
    html += `<td>${c.physicalStatus || '-'}</td>`;
    html += `<td>${c.isEmergency ? 'Y' : ''}</td>`;
    html += `<td>${addOns || '-'}</td>`;
    html += `<td><strong>${pts.toFixed(1)}</strong></td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function filterCaseLog() {
  const query = (document.getElementById('caseLogSearch').value || '').toLowerCase();
  const table = document.getElementById('caseLogTable');
  if (!table) return;
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(query) ? '' : 'none';
  });
}

// ================================================================
// PROJECTIONS TAB
// ================================================================
function renderProjections() {
  renderMonthlyChart();
  renderBreakdownChart();
  renderStabilization();
  renderProjectedAnnual();
  renderShiftEfficiency();
  renderMoMChange();
}

function getMonthlyTotals() {
  const months = {};
  Object.values(data.shifts).forEach(shift => {
    const mk = shift.date.substring(0, 7);
    if (!months[mk]) months[mk] = 0;
    months[mk] += calcShiftTotal(shift).total;
  });
  return months;
}

function renderMonthlyChart() {
  const totals = getMonthlyTotals();
  const sortedKeys = Object.keys(totals).sort();
  const last6 = sortedKeys.slice(-6);
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const labels = last6.map(k => { const [y,m] = k.split('-'); return monthNames[parseInt(m)-1] + ' ' + y; });
  const values = last6.map(k => round2(totals[k]));
  const avg = values.length > 0 ? round2(values.reduce((a, b) => a + b, 0) / values.length) : 0;
  const ctx = document.getElementById('monthlyChart').getContext('2d');
  if (monthlyChart) monthlyChart.destroy();
  const datasets = [
    { label: 'Total Points', data: values, backgroundColor: 'rgba(59,130,246,0.7)', borderColor: '#3b82f6', borderWidth: 1, borderRadius: 4 }
  ];
  if (values.length > 1) {
    datasets.push({
      label: 'Average', data: values.map(() => avg), type: 'line',
      borderColor: '#f59e0b', borderWidth: 2, borderDash: [6, 3],
      pointRadius: 0, fill: false
    });
  }
  monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: values.length > 1, labels: { color: '#94a3b8' } } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(71,85,105,0.3)' } },
        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
      }
    }
  });
  // Summary text below chart
  const summaryEl = document.getElementById('monthlyChartSummary');
  let summaryText = values.length > 0 ? `6-Month Avg: ${avg.toFixed(1)} pts` : '';
  const pv = settings.pointValue;
  if (pv && pv > 0 && avg > 0) {
    const projected = avg * pv;
    summaryText += ` &nbsp;|&nbsp; Projected Monthly: $${projected.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  }
  summaryEl.innerHTML = summaryText;
}

function renderBreakdownChart() {
  const now = new Date();
  const prefix = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  const monthShifts = Object.values(data.shifts).filter(s => s.date.startsWith(prefix));
  let obProd = 0, orProd = 0, totalAR = 0, totalCall = 0, totalSupervision = 0;
  monthShifts.forEach(shift => {
    const t = calcShiftTotal(shift);
    totalAR += t.ar;
    totalCall += t.call + t.subspec;
    totalSupervision += t.supervision;
    // Split prod by OB vs OR shift type
    if (['OB_restricted','SF1','SF2'].includes(shift.assignmentType)) obProd += t.prod;
    else orProd += t.prod;
  });
  const ctx = document.getElementById('breakdownChart').getContext('2d');
  if (breakdownChart) breakdownChart.destroy();
  breakdownChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['OB','OR','Supervision','Availability','Call'],
      datasets: [{ data: [round2(obProd), round2(orProd), round2(totalSupervision), round2(totalAR), round2(totalCall)], backgroundColor: ['#ec4899','#10b981','#8b5cf6','#3b82f6','#f59e0b'], borderWidth: 0 }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 16 } } } }
  });
}

function renderStabilization() {
  const now = new Date();
  const mt = getMonthlyTotals();
  function mk(offset) { const d = new Date(now.getFullYear(), now.getMonth() - offset, 1); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
  const raw = mt[mk(0)] || 0;
  const weighted = round2(0.10 * raw + 0.40 * (mt[mk(1)]||0) + 0.25 * (mt[mk(2)]||0) + 0.15 * (mt[mk(3)]||0) + 0.10 * (mt[mk(4)]||0));
  document.getElementById('stabRaw').textContent = raw.toFixed(1);
  document.getElementById('stabWeighted').textContent = weighted.toFixed(1);
  const pv = settings.pointValue;
  if (pv && pv > 0) {
    const paycheck = weighted * pv;
    document.getElementById('stabPaycheck').textContent = '$' + paycheck.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  } else {
    document.getElementById('stabPaycheck').innerHTML = '&mdash;';
  }
}

// ================================================================
// PROJECTED ANNUAL, SHIFT EFFICIENCY, MOM CHANGE
// ================================================================
function renderProjectedAnnual() {
  const mt = getMonthlyTotals();
  const now = new Date();
  function mk(offset) { const d = new Date(now.getFullYear(), now.getMonth() - offset, 1); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
  const last3 = [mt[mk(0)]||0, mt[mk(1)]||0, mt[mk(2)]||0].filter(v => v > 0);
  const avg = last3.length > 0 ? last3.reduce((a,b)=>a+b,0) / last3.length : 0;
  document.getElementById('projRollingAvg').textContent = avg.toFixed(1);
  const pv = settings.pointValue;
  if (pv && pv > 0 && avg > 0) {
    const annual = avg * 12 * pv;
    document.getElementById('projAnnualIncome').textContent = '$' + annual.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  } else {
    document.getElementById('projAnnualIncome').innerHTML = '&mdash;';
  }
}

function renderShiftEfficiency() {
  const allShifts = Object.values(data.shifts);
  const efficiencies = [];
  allShifts.forEach(shift => {
    const hrs = calcShiftHours(shift);
    if (hrs <= 0) return;
    const total = calcShiftTotal(shift).total;
    efficiencies.push({ date: shift.date, type: shift.assignmentType, ptsPerHr: round2(total / hrs), total, hrs });
  });
  efficiencies.sort((a, b) => b.ptsPerHr - a.ptsPerHr);
  const best5 = efficiencies.slice(0, 5);
  const worst5 = efficiencies.length > 5 ? efficiencies.slice(-5).reverse() : [];
  let html = '';
  if (best5.length > 0) {
    html += '<h4 style="font-size:0.82rem;color:var(--accent);margin-bottom:6px;">Top 5 (pts/hr)</h4>';
    best5.forEach(e => {
      html += `<div class="efficiency-item"><span class="eff-label">${formatDateShort(e.date)} — ${getAssignmentTypeName(e.type)}</span><span class="eff-value good">${e.ptsPerHr.toFixed(1)}</span></div>`;
    });
  }
  if (worst5.length > 0) {
    html += '<h4 style="font-size:0.82rem;color:var(--danger);margin-top:12px;margin-bottom:6px;">Bottom 5 (pts/hr)</h4>';
    worst5.forEach(e => {
      html += `<div class="efficiency-item"><span class="eff-label">${formatDateShort(e.date)} — ${getAssignmentTypeName(e.type)}</span><span class="eff-value bad">${e.ptsPerHr.toFixed(1)}</span></div>`;
    });
  }
  if (!html) html = '<p style="font-size:0.85rem;color:var(--text-dim);">No shift data yet.</p>';
  document.getElementById('efficiencyContent').innerHTML = html;
}

function renderMoMChange() {
  const mt = getMonthlyTotals();
  const now = new Date();
  function mk(offset) { const d = new Date(now.getFullYear(), now.getMonth() - offset, 1); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); }
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let html = '';
  for (let i = 0; i < 3; i++) {
    const key = mk(i);
    const prevKey = mk(i + 1);
    const curr = mt[key] || 0;
    const prev = mt[prevKey] || 0;
    const [y, m] = key.split('-');
    const label = monthNames[parseInt(m)-1] + ' ' + y;
    let change = '', cls = 'trend-flat';
    if (prev > 0) {
      const pct = round2(((curr - prev) / prev) * 100);
      if (pct > 0) { change = `+${pct.toFixed(1)}%`; cls = 'trend-up'; }
      else if (pct < 0) { change = `${pct.toFixed(1)}%`; cls = 'trend-down'; }
      else { change = '0%'; }
    } else {
      change = curr > 0 ? 'New' : '-';
    }
    html += `<div class="efficiency-item"><span class="eff-label">${label}: ${curr.toFixed(0)} pts</span><span class="eff-value ${cls}">${change}</span></div>`;
  }
  document.getElementById('momContent').innerHTML = html || '<p style="font-size:0.85rem;color:var(--text-dim);">Not enough data.</p>';
}

// ================================================================
// TIME TAB
// ================================================================
function renderTimeTab() {
  renderTimeSummary();
  renderProductionTrend();
  renderDayOfWeekHeatmap();
  renderWeekendVsWeekday();
  renderNightCallFreq();
}

function getRecentShifts(months) {
  const now = new Date();
  const cutoff = new Date(now.getFullYear(), now.getMonth() - months, 1);
  const cutoffStr = cutoff.getFullYear() + '-' + String(cutoff.getMonth()+1).padStart(2,'0') + '-01';
  return Object.values(data.shifts).filter(s => s.date >= cutoffStr);
}

function renderTimeSummary() {
  const recent = getRecentShifts(3);
  if (recent.length === 0) {
    document.getElementById('timeAvgMonth').textContent = '0';
    document.getElementById('timeAvgWeek').textContent = '0';
    document.getElementById('timeAvgStart').textContent = '--:--';
    document.getElementById('timeAvgEnd').textContent = '--:--';
    return;
  }
  let totalHours = 0, totalStartMin = 0, totalEndMin = 0, count = 0;
  recent.forEach(s => {
    const hrs = calcShiftHours(s);
    if (hrs > 0) {
      totalHours += hrs;
      const entries = s.timeEntries || [{ start: s.startTime, end: s.endTime }];
      totalStartMin += timeToMinutes(entries[0].start);
      const lastEnd = entries[entries.length - 1].end;
      totalEndMin += timeToMinutes(lastEnd || entries[0].start);
      count++;
    }
  });
  const avgMonthHrs = count > 0 ? round2(totalHours / 3) : 0;
  const avgWeekHrs = count > 0 ? round2(totalHours / 13) : 0; // ~13 weeks in 3 months
  document.getElementById('timeAvgMonth').textContent = avgMonthHrs.toFixed(0);
  document.getElementById('timeAvgWeek').textContent = avgWeekHrs.toFixed(0);
  if (count > 0) {
    const avgSM = Math.round(totalStartMin / count);
    const avgEM = Math.round(totalEndMin / count);
    document.getElementById('timeAvgStart').textContent = String(Math.floor(avgSM/60)).padStart(2,'0') + ':' + String(avgSM%60).padStart(2,'0');
    document.getElementById('timeAvgEnd').textContent = String(Math.floor(avgEM/60)).padStart(2,'0') + ':' + String(avgEM%60).padStart(2,'0');
  }
}

function renderProductionTrend() {
  const mt = getMonthlyTotals();
  const sortedKeys = Object.keys(mt).sort();
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const labels = sortedKeys.map(k => { const [y,m] = k.split('-'); return monthNames[parseInt(m)-1] + ' ' + y; });
  const values = sortedKeys.map(k => round2(mt[k]));
  const ctx = document.getElementById('productionTrendChart').getContext('2d');
  if (productionTrendChart) productionTrendChart.destroy();
  productionTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: 'Monthly Points', data: values, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#3b82f6' }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(71,85,105,0.3)' } },
        x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { display: false } }
      }
    }
  });
}

function renderDayOfWeekHeatmap() {
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const hoursByDay = [0,0,0,0,0,0,0];
  const ptsByDay = [0,0,0,0,0,0,0];
  const countByDay = [0,0,0,0,0,0,0];
  Object.values(data.shifts).forEach(s => {
    const d = new Date(s.date + 'T12:00:00');
    const dow = d.getDay();
    const hrs = calcShiftHours(s);
    hoursByDay[dow] += hrs;
    ptsByDay[dow] += calcShiftTotal(s).total;
    countByDay[dow]++;
  });
  const maxHrs = Math.max(...hoursByDay, 1);
  let html = '';
  for (let i = 1; i <= 7; i++) {
    const idx = i % 7; // Mon first, Sun last
    const pct = maxHrs > 0 ? (hoursByDay[idx] / maxHrs * 100) : 0;
    html += `<div class="heatmap-row">
      <span class="hm-label">${days[idx]}</span>
      <div style="flex:1;display:flex;gap:4px;align-items:center;">
        <div class="heatmap-bar" style="width:${pct}%"></div>
        <div class="heatmap-bar green" style="width:${maxHrs > 0 ? (ptsByDay[idx] / Math.max(...ptsByDay, 1) * 100) : 0}%"></div>
      </div>
      <span class="hm-value">${hoursByDay[idx].toFixed(0)}h / ${ptsByDay[idx].toFixed(0)}pts</span>
    </div>`;
  }
  document.getElementById('dowContent').innerHTML = html || '<p style="color:var(--text-dim);font-size:0.85rem;">No data.</p>';
}

function renderWeekendVsWeekday() {
  let wdHrs = 0, wdPts = 0, wdN = 0, weHrs = 0, wePts = 0, weN = 0;
  Object.values(data.shifts).forEach(s => {
    const hrs = calcShiftHours(s);
    const pts = calcShiftTotal(s).total;
    if (isWeekend(s.date)) { weHrs += hrs; wePts += pts; weN++; }
    else { wdHrs += hrs; wdPts += pts; wdN++; }
  });
  let html = '<div class="summary-grid">';
  html += `<div class="summary-item"><div class="label">Weekday Avg Pts</div><div class="value blue">${wdN > 0 ? (wdPts/wdN).toFixed(1) : '0'}</div></div>`;
  html += `<div class="summary-item"><div class="label">Weekend Avg Pts</div><div class="value green">${weN > 0 ? (wePts/weN).toFixed(1) : '0'}</div></div>`;
  html += `<div class="summary-item"><div class="label">Weekday Avg Hrs</div><div class="value blue">${wdN > 0 ? (wdHrs/wdN).toFixed(1) : '0'}</div></div>`;
  html += `<div class="summary-item"><div class="label">Weekend Avg Hrs</div><div class="value green">${weN > 0 ? (weHrs/weN).toFixed(1) : '0'}</div></div>`;
  html += `<div class="summary-item"><div class="label">Weekday Shifts</div><div class="value">${wdN}</div></div>`;
  html += `<div class="summary-item"><div class="label">Weekend Shifts</div><div class="value">${weN}</div></div>`;
  html += '</div>';
  document.getElementById('wkndContent').innerHTML = html;
}

function renderNightCallFreq() {
  const allShifts = Object.values(data.shifts);
  const total = allShifts.length;
  let nightCount = 0, callEligibleCount = 0, multiEntryCount = 0;
  allShifts.forEach(s => {
    const start = timeToMinutes(s.startTime);
    if (start >= 1020) nightCount++;
    if (UNRESTRICTED_CALL_TYPES.has(s.assignmentType)) callEligibleCount++;
    if (s.timeEntries && s.timeEntries.length > 1) multiEntryCount++;
  });
  let html = `<div class="efficiency-item"><span class="eff-label">Night Shifts (start >= 17:00)</span><span class="eff-value">${nightCount} (${total > 0 ? round2(nightCount/total*100).toFixed(0) : 0}%)</span></div>`;
  html += `<div class="efficiency-item"><span class="eff-label">Call-Eligible Shifts</span><span class="eff-value">${callEligibleCount} (${total > 0 ? round2(callEligibleCount/total*100).toFixed(0) : 0}%)</span></div>`;
  html += `<div class="efficiency-item"><span class="eff-label">Multi-Entry Shifts</span><span class="eff-value">${multiEntryCount}</span></div>`;
  html += `<div class="efficiency-item"><span class="eff-label">Total Shifts</span><span class="eff-value">${total}</span></div>`;
  document.getElementById('nightContent').innerHTML = html;
}

// ================================================================
// ANALYTICS TAB
// ================================================================
function renderAnalyticsTab() {
  renderCaseMix();
  renderAddOnUtil();
  renderTopProcedures();
  renderAvgUnits();
  renderShiftDistChart();
}

function renderCaseMix() {
  const freq = {};
  data.cases.forEach(c => {
    const name = c.caseType === 'standard' ? (c.procedure || 'Standard') : getCaseTypeName(c.caseType);
    freq[name] = (freq[name] || 0) + 1;
  });
  const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]);
  const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
  if (sorted.length === 0) {
    document.getElementById('caseMixContent').innerHTML = '<div class="empty-state"><p>No case data.</p></div>';
    return;
  }
  let html = '';
  sorted.slice(0, 20).forEach(([name, count]) => {
    const pct = (count / maxCount * 100);
    html += `<div class="case-mix-item"><span class="cm-label" title="${escHtml(name)}">${escHtml(name)}</span><div class="case-mix-bar-wrap"><div class="case-mix-bar" style="width:${pct}%"></div></div><span class="cm-count">${count}</span></div>`;
  });
  document.getElementById('caseMixContent').innerHTML = html;
}

function renderAddOnUtil() {
  const stdCases = data.cases.filter(c => c.caseType === 'standard');
  const total = stdCases.length;
  if (total === 0) { document.getElementById('addOnContent').innerHTML = '<p style="color:var(--text-dim);font-size:0.85rem;">No standard cases.</p>'; return; }
  const counts = { 'Nerve Block': 0, 'Central Line': 0, 'Arterial Line': 0, 'PAC': 0, 'TEE': 0 };
  stdCases.forEach(c => {
    if (c.nerveBlock && c.nerveBlock !== 'none') counts['Nerve Block']++;
    if (c.hasCentralLine) counts['Central Line']++;
    if (c.hasArterialLine) counts['Arterial Line']++;
    if (c.hasPAC) counts['PAC']++;
    if (c.hasTEEAddOn) counts['TEE']++;
  });
  let html = '';
  Object.entries(counts).forEach(([name, count]) => {
    const pct = round2(count / total * 100);
    html += `<div class="efficiency-item"><span class="eff-label">${name}</span><span class="eff-value">${count} (${pct.toFixed(0)}%)</span></div>`;
  });
  document.getElementById('addOnContent').innerHTML = html;
}

function renderTopProcedures() {
  const ptsByProc = {};
  data.cases.forEach(c => {
    const name = c.caseType === 'standard' ? (c.procedure || 'Standard') : getCaseTypeName(c.caseType);
    const shift = data.shifts[c.shiftDate];
    const pts = calcCasePoints(c, shift);
    ptsByProc[name] = (ptsByProc[name] || 0) + pts;
  });
  const sorted = Object.entries(ptsByProc).sort((a, b) => b[1] - a[1]).slice(0, 10);
  if (sorted.length === 0) { document.getElementById('topProcContent').innerHTML = '<p style="color:var(--text-dim);font-size:0.85rem;">No data.</p>'; return; }
  let html = '';
  sorted.forEach(([name, pts], i) => {
    html += `<div class="efficiency-item"><span class="eff-label">${i+1}. ${escHtml(name)}</span><span class="eff-value">${pts.toFixed(1)} pts</span></div>`;
  });
  document.getElementById('topProcContent').innerHTML = html;
}

function renderAvgUnits() {
  const stdCases = data.cases.filter(c => c.caseType === 'standard' && parseFloat(c.baseUnits) > 0);
  if (stdCases.length === 0) { document.getElementById('avgUnitsContent').innerHTML = '<p style="color:var(--text-dim);font-size:0.85rem;">No standard cases with units.</p>'; return; }
  const totalUnits = stdCases.reduce((s, c) => s + (parseFloat(c.baseUnits) || 0), 0);
  const avg = round2(totalUnits / stdCases.length);
  const maxUnits = Math.max(...stdCases.map(c => parseFloat(c.baseUnits) || 0));
  const minUnits = Math.min(...stdCases.map(c => parseFloat(c.baseUnits) || 0));
  let html = '<div class="summary-grid">';
  html += `<div class="summary-item"><div class="label">Average</div><div class="value blue">${avg.toFixed(1)}</div></div>`;
  html += `<div class="summary-item"><div class="label">Cases</div><div class="value green">${stdCases.length}</div></div>`;
  html += `<div class="summary-item"><div class="label">Min</div><div class="value">${minUnits}</div></div>`;
  html += `<div class="summary-item"><div class="label">Max</div><div class="value">${maxUnits}</div></div>`;
  html += '</div>';
  document.getElementById('avgUnitsContent').innerHTML = html;
}

function renderShiftDistChart() {
  const counts = {};
  Object.values(data.shifts).forEach(s => {
    const name = getAssignmentTypeName(s.assignmentType);
    counts[name] = (counts[name] || 0) + 1;
  });
  const labels = Object.keys(counts);
  const values = Object.values(counts);
  if (labels.length === 0) return;
  const ctx = document.getElementById('shiftDistChart').getContext('2d');
  if (shiftDistChart) shiftDistChart.destroy();
  const colors = ['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ec4899','#ef4444','#06b6d4','#84cc16','#f97316','#6366f1','#14b8a6','#e11d48','#a855f7'];
  shiftDistChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 12, font: { size: 11 } } } } }
  });
}

let editingCaseId = null;
let editCaseType = 'standard';

// Edit modal case type grid
document.querySelectorAll('#editCaseTypeGrid .case-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#editCaseTypeGrid .case-type-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    editCaseType = btn.dataset.ecase;
    const isStd = editCaseType === 'standard';
    const isLabor = editCaseType === 'labor_epidural';
    const isAPS = editCaseType === 'aps_rounding';
    document.getElementById('editStandardFields').classList.toggle('hidden', !isStd);
    document.getElementById('editLaborEpiduralFields').classList.toggle('hidden', !isLabor);
    document.getElementById('editApsRoundingFields').classList.toggle('hidden', !isAPS);
    document.getElementById('editSimpleFields').classList.toggle('hidden', isStd || isLabor || isAPS);
  });
});

document.getElementById('editCaseMedicalProc').addEventListener('change', function() {
  document.getElementById('editMedicalUnitsRow').classList.toggle('hidden', !this.checked);
});

document.getElementById('editCaseAcutePain').addEventListener('change', function() {
  document.getElementById('editAcutePainUnitsRow').classList.toggle('hidden', !this.checked);
});

function openCaseEdit(caseId) {
  const c = data.cases.find(x => x.id === caseId);
  if (!c) return;
  editingCaseId = caseId;
  editCaseType = c.caseType || 'standard';

  // Set case type
  document.querySelectorAll('#editCaseTypeGrid .case-type-btn').forEach(b => {
    b.classList.toggle('selected', b.dataset.ecase === editCaseType);
  });
  const isStd = editCaseType === 'standard';
  const isLabor = editCaseType === 'labor_epidural';
  const isAPS = editCaseType === 'aps_rounding';
  document.getElementById('editStandardFields').classList.toggle('hidden', !isStd);
  document.getElementById('editLaborEpiduralFields').classList.toggle('hidden', !isLabor);
  document.getElementById('editApsRoundingFields').classList.toggle('hidden', !isAPS);
  document.getElementById('editSimpleFields').classList.toggle('hidden', isStd || isLabor || isAPS);

  // Fill fields
  document.getElementById('editCaseProcedure').value = c.procedure || '';
  document.getElementById('editCaseBaseUnits').value = c.baseUnits || 0;
  document.getElementById('editCasePhysicalStatus').value = c.physicalStatus || 'P3';
  document.getElementById('editCaseStart').value = c.startTime || '';
  document.getElementById('editCaseEnd').value = c.endTime || '';
  document.getElementById('editCaseEmergency').checked = c.isEmergency || false;
  document.getElementById('editCaseMedicalProc').checked = c.isMedicalProc || false;
  document.getElementById('editMedicalUnitsRow').classList.toggle('hidden', !c.isMedicalProc);
  document.getElementById('editCaseMedicalUnits').value = c.medicalUnits || 0;
  document.getElementById('editCaseAcutePain').checked = c.isAcutePain || false;
  document.getElementById('editAcutePainUnitsRow').classList.toggle('hidden', !c.isAcutePain);
  document.getElementById('editCaseAcutePainUnits').value = c.acutePainUnits || 0;
  document.getElementById('editCaseHighRiskPeds').checked = c.isHighRiskPeds || false;
  document.getElementById('editCaseNotes').value = c.notes || '';
  document.getElementById('editSimpleNotes').value = c.notes || '';

  // Add-ons
  document.getElementById('editNerveBlock').value = c.nerveBlock || 'none';
  document.getElementById('editCentralLine').checked = c.hasCentralLine || false;
  document.getElementById('editArterialLine').checked = c.hasArterialLine || false;
  document.getElementById('editPAC').checked = c.hasPAC || false;
  document.getElementById('editTEEAddOn').checked = c.hasTEEAddOn || false;

  // Labor epidural fields
  if (editCaseType === 'labor_epidural') {
    document.getElementById('editLaborStart').value = c.startTime || '';
    document.getElementById('editLaborEnd').value = c.endTime || '';
  }

  // APS rounding fields
  if (editCaseType === 'aps_rounding') {
    document.getElementById('editApsEpiduralCount').value = c.epiduralRounds || 0;
    document.getElementById('editApsPainCount').value = c.painRounds || 0;
  }

  // OR Case checkbox visibility
  const shift = data.shifts[c.shiftDate];
  const isSF = shift && ['SF1','SF2'].includes(shift.assignmentType);
  document.getElementById('editORCaseRow').classList.toggle('hidden', !isSF);
  document.getElementById('editCaseORCase').checked = c.isORCase || false;

  document.getElementById('caseEditModal').classList.remove('hidden');
}

document.getElementById('saveCaseEdit').addEventListener('click', () => {
  const c = data.cases.find(x => x.id === editingCaseId);
  if (!c) return;
  c.caseType = editCaseType;
  if (editCaseType === 'standard') {
    c.procedure = document.getElementById('editCaseProcedure').value;
    c.baseUnits = document.getElementById('editCaseBaseUnits').value;
    c.physicalStatus = document.getElementById('editCasePhysicalStatus').value;
    c.startTime = document.getElementById('editCaseStart').value;
    c.endTime = document.getElementById('editCaseEnd').value;
    c.isEmergency = document.getElementById('editCaseEmergency').checked;
    c.isMedicalProc = document.getElementById('editCaseMedicalProc').checked;
    c.medicalUnits = document.getElementById('editCaseMedicalUnits').value;
    c.isAcutePain = document.getElementById('editCaseAcutePain').checked;
    c.acutePainUnits = document.getElementById('editCaseAcutePainUnits').value;
    c.isHighRiskPeds = document.getElementById('editCaseHighRiskPeds').checked;
    c.isORCase = document.getElementById('editCaseORCase').checked;
    c.nerveBlock = document.getElementById('editNerveBlock').value;
    c.hasCentralLine = document.getElementById('editCentralLine').checked;
    c.hasArterialLine = document.getElementById('editArterialLine').checked;
    c.hasPAC = document.getElementById('editPAC').checked;
    c.hasTEEAddOn = document.getElementById('editTEEAddOn').checked;
    c.notes = document.getElementById('editCaseNotes').value;
  } else if (editCaseType === 'labor_epidural') {
    c.procedure = 'Labor Epidural';
    c.startTime = document.getElementById('editLaborStart').value;
    c.endTime = document.getElementById('editLaborEnd').value;
    c.notes = document.getElementById('editCaseNotes').value;
  } else if (editCaseType === 'aps_rounding') {
    c.procedure = 'APS Rounding';
    c.epiduralRounds = document.getElementById('editApsEpiduralCount').value;
    c.painRounds = document.getElementById('editApsPainCount').value;
    c.notes = document.getElementById('editCaseNotes').value;
  } else {
    c.notes = document.getElementById('editSimpleNotes').value || document.getElementById('editCaseNotes').value;
  }
  saveData(data);
  updateHeaderPoints();
  renderCaseLogTable();
  document.getElementById('caseEditModal').classList.add('hidden');
  showToast('Case updated');
});

document.getElementById('cancelCaseEdit').addEventListener('click', () => {
  document.getElementById('caseEditModal').classList.add('hidden');
});

document.getElementById('caseEditModal').addEventListener('click', (e) => {
  if (e.target.id === 'caseEditModal') document.getElementById('caseEditModal').classList.add('hidden');
});

function deleteCaseFromList(id) {
  if (!confirm('Delete this case?')) return;
  data.cases = data.cases.filter(c => c.id !== id);
  saveData(data);
  updateHeaderPoints();
  renderCaseLogTable();
  showToast('Case deleted');
}

// ================================================================
// EXPORT / IMPORT
// ================================================================
document.getElementById('exportCSVBtn').addEventListener('click', () => {
  const prefix = `${historyYear}-${String(historyMonth+1).padStart(2,'0')}`;
  const monthShifts = Object.values(data.shifts).filter(s => s.date.startsWith(prefix)).sort((a,b) => a.date.localeCompare(b.date));
  let csv = 'Date,Assignment,Time Entries,Entries Count,AR Points,Productivity Points,Call Points,Subspec Points,Supervision Points,Total Points,Cases\n';
  monthShifts.forEach(shift => {
    const totals = calcShiftTotal(shift);
    const cc = data.cases.filter(c => c.shiftDate === shift.date).length;
    const entries = shift.timeEntries || [{ start: shift.startTime, end: shift.endTime }];
    const timeStr = entries.map(e => `${e.start}-${e.end || '?'}`).join('; ');
    csv += `${shift.date},${getAssignmentTypeName(shift.assignmentType)},"${timeStr}",${entries.length},${totals.ar.toFixed(2)},${totals.prod.toFixed(2)},${totals.call.toFixed(2)},${totals.subspec.toFixed(2)},${totals.supervision.toFixed(2)},${totals.total.toFixed(2)},${cc}\n`;
  });
  const namePrefix = settings.name ? settings.name.replace(/\s+/g, '_') + '_' : '';
  downloadFile(csv, `${namePrefix}mwa-points-${prefix}.csv`, 'text/csv');
  showToast('CSV exported!');
});

document.getElementById('exportAllBtn').addEventListener('click', () => {
  const namePrefix = settings.name ? settings.name.replace(/\s+/g, '_') + '_' : '';
  downloadFile(JSON.stringify(data, null, 2), `${namePrefix}mwa-backup.json`, 'application/json');
  showToast('Data exported!');
});

document.getElementById('importFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (imported.shifts && imported.cases) {
        if (confirm('This will replace all existing data. Continue?')) {
          data = imported;
          migrateData(data); // handles timeEntries migration for old format
          updateHeaderPoints();
          showToast('Data imported!');
          renderHistory();
        }
      } else { showToast('Invalid file format'); }
    } catch(err) { showToast('Error reading file'); }
  };
  reader.readAsText(file);
  e.target.value = '';
});

document.getElementById('clearAllBtn').addEventListener('click', () => {
  if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
    if (confirm('Really delete everything?')) {
      data = { shifts: {}, cases: [] };
      saveData(data);
      updateHeaderPoints();
      showToast('All data cleared');
      renderHistory();
    }
  }
});

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ================================================================
// SETTINGS
// ================================================================
const nameInput = document.getElementById('settingsName');
nameInput.value = settings.name || '';
nameInput.addEventListener('change', () => {
  settings.name = nameInput.value;
  saveSettings(settings);
  showToast('Name saved');
});

const pointValueInput = document.getElementById('settingsPointValue');
pointValueInput.value = settings.pointValue || '';
pointValueInput.addEventListener('change', () => {
  settings.pointValue = parseFloat(pointValueInput.value) || 0;
  saveSettings(settings);
  showToast('Point value saved');
});

// ================================================================
// HEADER POINTS
// ================================================================
function updateHeaderPoints() {
  const date = workingDate;
  const shift = data.shifts[date];
  if (shift) {
    const totals = calcShiftTotal(shift);
    document.getElementById('headerPoints').textContent = totals.total.toFixed(1) + ' pts';
  } else {
    document.getElementById('headerPoints').textContent = '0 pts';
  }
}

// ================================================================
// RECONCILE PAGE — Tab switching
// ================================================================
// Main reconcile tabs
document.querySelectorAll('#page-reconcile > .tab-bar > .tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#page-reconcile > .tab-bar > .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('rtab-qgenda').classList.toggle('hidden', btn.dataset.rtab !== 'qgenda');
    document.getElementById('rtab-production').classList.toggle('hidden', btn.dataset.rtab !== 'production');
    document.getElementById('rtab-import').classList.toggle('hidden', btn.dataset.rtab !== 'import');
  });
});

// Import sub-tabs
document.querySelectorAll('#importSubTabs .tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#importSubTabs .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('itab-time').classList.toggle('hidden', btn.dataset.itab !== 'time');
    document.getElementById('itab-cases').classList.toggle('hidden', btn.dataset.itab !== 'cases');
  });
});

function renderReconTabs() {
  updateReconMonthLabels();
}

// ================================================================
// QGENDA RECONCILIATION
// ================================================================
let qgendaData = [];
let qYear = new Date().getFullYear();
let qMonth = new Date().getMonth();

function updateReconMonthLabels() {
  const mn = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('qMonthLabel').textContent = `${mn[qMonth]} ${qYear}`;
  document.getElementById('pMonthLabel').textContent = `${mn[pMonth]} ${pYear}`;
}

document.getElementById('qPrevMonth').addEventListener('click', () => { qMonth--; if (qMonth < 0) { qMonth = 11; qYear--; } updateReconMonthLabels(); renderQgendaRecon(); });
document.getElementById('qNextMonth').addEventListener('click', () => { qMonth++; if (qMonth > 11) { qMonth = 0; qYear++; } updateReconMonthLabels(); renderQgendaRecon(); });

// Upload area
document.getElementById('qgendaUploadArea').addEventListener('click', () => document.getElementById('qgendaFile').click());

function processQgendaRows(rows) {
  qgendaData = rows.map(r => {
    let schedDate = parseExcelDate(r['Schedule Date']);
    let clockInDate = parseExcelDate(r['Effective Clock In Date']);
    let clockOutDate = parseExcelDate(r['Effective Clock Out Date']);
    return {
      scheduleDate: schedDate,
      clockInDate: clockInDate,
      clockInTime: parseExcelTime(r['Effective Clock In Time']),
      clockOutDate: clockOutDate,
      clockOutTime: parseExcelTime(r['Effective Clock Out Time']),
      duration: parseFloat(r['Duration']) || 0,
      task: String(r['Scheduled Task Abbreviation'] || ''),
      location: String(r['Location Name'] || ''),
      notes: String(r['Notes'] || '')
    };
  });
  localStorage.setItem(QGENDA_KEY, JSON.stringify(qgendaData));
  showToast(`Loaded ${qgendaData.length} QGenda entries`);
  if (qgendaData.length > 0 && qgendaData[0].scheduleDate) {
    const d = new Date(qgendaData[0].scheduleDate + 'T12:00:00');
    if (!isNaN(d)) { qYear = d.getFullYear(); qMonth = d.getMonth(); updateReconMonthLabels(); }
  }
  renderQgendaRecon();
}

function parseCSVRows(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  if (lines.length < 2) return [];
  // Parse header row — handle quoted fields
  const parseCSVLine = (line) => {
    const fields = [];
    let current = '', inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') { inQuotes = !inQuotes; }
      else if (ch === ',' && !inQuotes) { fields.push(current.trim()); current = ''; }
      else { current += ch; }
    }
    fields.push(current.trim());
    return fields;
  };
  const headers = parseCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h, idx) => { obj[h] = vals[idx] || ''; });
    rows.push(obj);
  }
  return rows;
}

document.getElementById('qgendaFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const isImage = /\.(png|jpg|jpeg)$/i.test(file.name);
  const isCSV = /\.csv$/i.test(file.name);

  if (isImage) {
    try {
      showToast('Running OCR on image...');
      const text = await ocrImage(file);
      qgendaData = parseQgendaScreenshot(text);
      localStorage.setItem(QGENDA_KEY, JSON.stringify(qgendaData));
      showToast(`OCR found ${qgendaData.length} QGenda entries`);
      if (qgendaData.length > 0 && qgendaData[0].scheduleDate) {
        const d = new Date(qgendaData[0].scheduleDate + 'T12:00:00');
        if (!isNaN(d)) { qYear = d.getFullYear(); qMonth = d.getMonth(); updateReconMonthLabels(); }
      }
      renderQgendaRecon();
    } catch(err) {
      showToast('OCR error: ' + err.message);
    }
  } else if (isCSV) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const rows = parseCSVRows(ev.target.result);
        processQgendaRows(rows);
      } catch(err) {
        showToast('Error reading CSV: ' + err.message);
      }
    };
    reader.readAsText(file);
  } else {
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const wb = XLSX.read(ev.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
        processQgendaRows(rows);
      } catch(err) {
        showToast('Error reading QGenda file: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }
  e.target.value = '';
});

function parseExcelDate(val) {
  if (!val && val !== 0) return '';
  // Excel serial number
  if (typeof val === 'number') {
    const d = new Date((val - 25569) * 86400 * 1000);
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }
  // String like "1/2/2026" or "2026-01-02"
  const s = String(val).trim();
  if (s.includes('-') && s.length === 10) return s; // already YYYY-MM-DD
  const parts = s.split('/');
  if (parts.length === 3) {
    let [m, d, y] = parts.map(Number);
    if (y < 100) y += 2000;
    return y + '-' + String(m).padStart(2,'0') + '-' + String(d).padStart(2,'0');
  }
  return s;
}

function parseExcelTime(val) {
  if (!val && val !== 0) return '';
  // Excel fractional day (0.0 to 1.0)
  if (typeof val === 'number' && val < 1) {
    const totalMin = Math.round(val * 1440);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  }
  // String like "7:00" or "13:01"
  const s = String(val).trim();
  if (s.includes(':')) {
    const [h, m] = s.split(':').map(Number);
    return String(h).padStart(2,'0') + ':' + String(m || 0).padStart(2,'0');
  }
  return s;
}

function renderQgendaRecon() {
  // Load cached data if needed
  if (qgendaData.length === 0) {
    try {
      const cached = localStorage.getItem(QGENDA_KEY);
      if (cached) qgendaData = JSON.parse(cached);
    } catch(e) {}
  }

  const container = document.getElementById('qgendaResults');
  const prefix = `${qYear}-${String(qMonth+1).padStart(2,'0')}`;

  // Filter QGenda entries for month (by Schedule Date)
  const qEntries = qgendaData.filter(e => e.scheduleDate && e.scheduleDate.startsWith(prefix));
  const trackerShifts = Object.values(data.shifts).filter(s => s.date.startsWith(prefix));

  if (qgendaData.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>Upload a QGenda export file to begin reconciliation.</p></div>';
    return;
  }

  if (qEntries.length === 0 && trackerShifts.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>No data for this month in QGenda or Tracker.</p></div>';
    return;
  }

  // Group QGenda by schedule date
  const qByDate = {};
  qEntries.forEach(e => {
    if (!qByDate[e.scheduleDate]) qByDate[e.scheduleDate] = [];
    qByDate[e.scheduleDate].push(e);
  });

  // Get all unique dates
  const allDates = new Set([...Object.keys(qByDate), ...trackerShifts.map(s => s.date)]);
  const sortedDates = [...allDates].sort();

  // Totals
  let qTotalHours = 0;
  let tTotalHours = 0;
  let matchCount = 0, warnCount = 0, missCount = 0;

  let html = '<div class="card"><h2>QGenda vs Tracker</h2>';
  html += '<table class="recon-table"><thead><tr><th>Date</th><th>QGenda</th><th>Tracker</th><th>Status</th></tr></thead><tbody>';

  sortedDates.forEach(date => {
    const qDay = qByDate[date] || [];
    const tShift = data.shifts[date];

    // QGenda total hours for the day
    const qHours = qDay.reduce((s, e) => s + e.duration, 0);
    qTotalHours += qHours;

    // Tracker hours (clocked-in only)
    let tHours = 0;
    if (tShift) {
      tHours = calcShiftHours(tShift);
      tTotalHours += tHours;
    }

    let status = '', rowClass = '';
    if (qDay.length > 0 && tShift) {
      const diff = Math.abs(qHours - tHours);
      if (diff <= 0.25) { status = 'Match'; rowClass = 'match'; matchCount++; }
      else if (diff <= 1) { status = 'Close'; rowClass = 'warn'; warnCount++; }
      else { status = `${diff.toFixed(1)}h diff`; rowClass = 'miss'; missCount++; }
    } else if (qDay.length > 0 && !tShift) {
      status = 'Missing in Tracker'; rowClass = 'miss'; missCount++;
    } else if (qDay.length === 0 && tShift) {
      status = 'Missing in QGenda'; rowClass = 'warn'; warnCount++;
    }

    const qDetail = qDay.map(e => `${e.clockInTime}-${e.clockOutTime}`).join(', ');
    const tEntries = tShift && tShift.timeEntries ? tShift.timeEntries : (tShift ? [{ start: tShift.startTime, end: tShift.endTime }] : []);
    const tDetail = tEntries.length > 0 ? tEntries.map(e => `${e.start}-${e.end || '?'}`).join(', ') : '-';

    html += `<tr class="${rowClass}">
      <td>${formatDateShort(date)}</td>
      <td>${qHours.toFixed(1)}h<br><span style="font-size:0.65rem;color:var(--text-dim)">${escHtml(qDetail)}</span></td>
      <td>${tHours > 0 ? tHours.toFixed(1) + 'h' : '-'}<br><span style="font-size:0.65rem;color:var(--text-dim)">${tDetail}</span></td>
      <td>${status}</td>
    </tr>`;
  });

  html += '</tbody></table></div>';

  // Summary card
  let summary = '<div class="card"><h2>Summary</h2><div class="summary-grid">';
  summary += `<div class="summary-item"><div class="label">QGenda Hours</div><div class="value blue">${qTotalHours.toFixed(1)}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Tracker Hours</div><div class="value green">${tTotalHours.toFixed(1)}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Matched</div><div class="value green">${matchCount}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Issues</div><div class="value" style="color:var(--danger)">${warnCount + missCount}</div></div>`;
  summary += '</div></div>';

  container.innerHTML = summary + html;
}

// ================================================================
// PRODUCTION RECONCILIATION (PDF)
// ================================================================
let prodData = [];
let pYear = new Date().getFullYear();
let pMonth = new Date().getMonth();

document.getElementById('pPrevMonth').addEventListener('click', () => { pMonth--; if (pMonth < 0) { pMonth = 11; pYear--; } updateReconMonthLabels(); renderProdRecon(); });
document.getElementById('pNextMonth').addEventListener('click', () => { pMonth++; if (pMonth > 11) { pMonth = 0; pYear++; } updateReconMonthLabels(); renderProdRecon(); });

document.getElementById('prodUploadArea').addEventListener('click', () => document.getElementById('prodFile').click());

document.getElementById('prodFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const isImage = /\.(png|jpg|jpeg)$/i.test(file.name);

  try {
    let allText = '';
    if (isImage) {
      showToast('Running OCR on image...');
      allText = await ocrImage(file);
      // Normalize OCR output: replace multiple spaces with tab for parseProdText
      allText = allText.split('\n').map(line => line.replace(/\s{2,}/g, '\t')).join('\n');
    } else {
      showToast('Parsing PDF...');
      if (!window.pdfjsLib) {
        const pdfjs = await import('https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.mjs');
        window.pdfjsLib = pdfjs;
        pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.mjs';
      }
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const items = textContent.items;
        const rows = {};
        items.forEach(item => {
          const y = Math.round(item.transform[5]);
          if (!rows[y]) rows[y] = [];
          rows[y].push({ x: item.transform[4], text: item.str });
        });
        const sortedYs = Object.keys(rows).map(Number).sort((a, b) => b - a);
        sortedYs.forEach(y => {
          const row = rows[y].sort((a, b) => a.x - b.x);
          allText += row.map(r => r.text).join('\t') + '\n';
        });
      }
    }

    prodData = parseProdText(allText);
    localStorage.setItem(PROD_KEY, JSON.stringify(prodData));
    showToast(`Loaded ${prodData.length} billing cases`);

    if (prodData.length > 0 && prodData[0].date) {
      const d = new Date(prodData[0].date + 'T12:00:00');
      if (!isNaN(d)) { pYear = d.getFullYear(); pMonth = d.getMonth(); updateReconMonthLabels(); }
    }
    renderProdRecon();
  } catch(err) {
    showToast('Error reading file: ' + err.message);
    console.error(err);
  }
  e.target.value = '';
});

// ================================================================
// TESSERACT OCR
// ================================================================
function loadTesseract() {
  if (window.Tesseract) return Promise.resolve();
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load Tesseract.js'));
    document.head.appendChild(s);
  });
}

async function ocrImage(file) {
  await loadTesseract();
  const worker = await Tesseract.createWorker('eng');
  const { data } = await worker.recognize(file);
  await worker.terminate();
  return data.text;
}

// ================================================================
// QGENDA SCREENSHOT PARSER
// ================================================================
function parseQgendaScreenshot(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  const entries = [];
  let currentYear = new Date().getFullYear();

  for (const line of lines) {
    // Look for date patterns: M/D, M/D/YY, M/D/YYYY
    const dateMatch = line.match(/(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?/);
    if (!dateMatch) continue;

    let [, month, day, year] = dateMatch;
    month = parseInt(month); day = parseInt(day);
    if (year) {
      year = parseInt(year);
      if (year < 100) year += 2000;
    } else {
      year = currentYear;
    }
    if (month < 1 || month > 12 || day < 1 || day > 31) continue;
    currentYear = year; // remember year for subsequent lines

    const dateStr = year + '-' + String(month).padStart(2,'0') + '-' + String(day).padStart(2,'0');

    // Look for military time pairs (H:MM or HH:MM)
    const times = line.match(/\d{1,2}:\d{2}/g);
    if (!times || times.length < 2) continue;

    // Parse time pairs
    for (let i = 0; i < times.length - 1; i += 2) {
      const clockIn = times[i].length === 4 ? '0' + times[i] : times[i];
      const clockOut = times[i+1].length === 4 ? '0' + times[i+1] : times[i+1];
      const inMin = timeToMinutes(clockIn);
      let outMin = timeToMinutes(clockOut);
      if (outMin <= inMin) outMin += 1440;
      const duration = (outMin - inMin) / 60;

      // Extract task abbreviation — text before or after the times
      const afterTimes = line.substring(line.lastIndexOf(times[i+1]) + times[i+1].length).trim();
      const beforeDate = line.substring(0, line.indexOf(dateMatch[0])).trim();
      const betweenDateAndTime = line.substring(line.indexOf(dateMatch[0]) + dateMatch[0].length, line.indexOf(times[i])).trim();
      const task = afterTimes || betweenDateAndTime || beforeDate || '';

      entries.push({
        scheduleDate: dateStr,
        clockInDate: dateStr,
        clockInTime: clockIn,
        clockOutDate: dateStr,
        clockOutTime: clockOut,
        duration: round2(duration),
        task: task.replace(/[^a-zA-Z0-9\s\/\-]/g, '').trim(),
        location: '',
        notes: ''
      });
    }
  }
  return entries;
}

// ================================================================
// IMPORT SHIFTS FROM QGENDA
// ================================================================
function mapTaskToAssignmentType(task, dateStr) {
  const t = (task || '').toUpperCase();
  // "UVH/SFH Work" → general OR
  if (/UVH\/SFH\s*WORK/.test(t)) return 'OR';
  // "Post" anything → always general OR (Post 1-4, Post SF 1/2, etc.)
  if (/\bPOST\b/.test(t)) return 'OR';
  // SFH prefix → SF1 or SF2 (check before call keywords so "SFH 1st Call" → SF1)
  if (/\bSFH\b/.test(t)) {
    if (/2/.test(t)) return 'SF2';
    return 'SF1';
  }
  // Call shifts: check for 1st-4th call keywords (may be prefixed with "UVH")
  if (/4TH|4C/.test(t)) return (dateStr && isWeekend(dateStr)) ? '4th_call' : 'ACS';
  if (/3RD|3C/.test(t)) return '3rd_call';
  if (/2ND|2C/.test(t)) return '2nd_call';
  if (/1ST|1C/.test(t)) return '1st_call';
  // "UVH" + number (without call keyword) → general OR (e.g. "UVH 3", "UVH 7")
  if (/\bUVH\s*\d/.test(t)) return 'OR';
  if (t.includes('NORA')) return 'NORA';
  if (t.includes('ACS') || t.includes('TOCR')) return 'ACS';
  if (t.includes('C/L') || t.includes('CARDIAC')) return 'cardiac_liver';
  if (t.includes('MOLE')) return 'mole';
  if (t.includes('CRNA')) return 'CRNA_supervision';
  if (t.includes('ENDO')) return 'endo';
  if (t.includes('SF1') || t.includes('SF 1')) return 'SF1';
  if (t.includes('SF2') || t.includes('SF 2')) return 'SF2';
  if (t.includes('OB') || t.includes('UVOC')) return 'OB_restricted';
  if (t.includes('OR')) return 'OR';
  return 'OR'; // fallback
}

let importTimeData = [];

function showImportTimePreview() {
  const area = document.getElementById('importTimeAction');
  const preview = document.getElementById('importTimePreview');
  if (importTimeData.length === 0) {
    area.classList.add('hidden');
    preview.innerHTML = '';
    return;
  }
  area.classList.remove('hidden');

  // Group by date for preview
  const byDate = {};
  importTimeData.forEach(e => {
    const d = e.scheduleDate;
    if (!d) return;
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(e);
  });

  const dates = Object.keys(byDate).sort();
  const existing = dates.filter(d => data.shifts[d]).length;
  const newDates = dates.filter(d => !data.shifts[d]).length;

  let html = '<div class="card" style="margin-top:12px;"><h3>Preview</h3>';
  html += `<p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:8px;">${dates.length} date${dates.length > 1 ? 's' : ''} found &mdash; ${newDates} new, ${existing} already exist</p>`;
  html += '<div style="max-height:250px;overflow-y:auto;font-size:0.8rem;">';
  dates.forEach(date => {
    const entries = byDate[date];
    const hasShift = data.shifts[date];
    const task = entries[0].task || '';
    const times = entries.map(e => `${e.clockInTime}-${e.clockOutTime}`).join(', ');
    const assignType = getAssignmentTypeName(mapTaskToAssignmentType(task, date));
    html += `<div style="padding:6px 0;border-bottom:1px solid var(--border);${hasShift ? 'opacity:0.5;' : ''}">`;
    html += `<strong>${formatDateShort(date)}</strong> &mdash; ${assignType}`;
    html += `<br><span style="color:var(--text-dim)">${times}${task ? ' (' + escHtml(task) + ')' : ''}${hasShift ? ' — already exists, will skip' : ''}</span>`;
    html += '</div>';
  });
  html += '</div></div>';
  preview.innerHTML = html;
}

// Import tab — time punch upload
document.getElementById('importTimeUploadArea').addEventListener('click', () => document.getElementById('importTimeFile').click());

document.getElementById('importTimeFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const isImage = /\.(png|jpg|jpeg)$/i.test(file.name);
  const isCSV = /\.csv$/i.test(file.name);

  try {
    if (isImage) {
      showToast('Running OCR on image...');
      const text = await ocrImage(file);
      importTimeData = parseQgendaScreenshot(text);
      showToast(`OCR found ${importTimeData.length} entries`);
    } else if (isCSV) {
      const text = await file.text();
      const rows = parseCSVRows(text);
      importTimeData = rows.map(r => {
        let schedDate = parseExcelDate(r['Schedule Date']);
        return {
          scheduleDate: schedDate,
          clockInDate: parseExcelDate(r['Effective Clock In Date']),
          clockInTime: parseExcelTime(r['Effective Clock In Time']),
          clockOutDate: parseExcelDate(r['Effective Clock Out Date']),
          clockOutTime: parseExcelTime(r['Effective Clock Out Time']),
          duration: parseFloat(r['Duration']) || 0,
          task: String(r['Scheduled Task Abbreviation'] || ''),
          location: String(r['Location Name'] || ''),
          notes: String(r['Notes'] || '')
        };
      });
      showToast(`Loaded ${importTimeData.length} entries from CSV`);
    } else {
      const arrayBuffer = await file.arrayBuffer();
      const wb = XLSX.read(arrayBuffer, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      importTimeData = rows.map(r => {
        let schedDate = parseExcelDate(r['Schedule Date']);
        return {
          scheduleDate: schedDate,
          clockInDate: parseExcelDate(r['Effective Clock In Date']),
          clockInTime: parseExcelTime(r['Effective Clock In Time']),
          clockOutDate: parseExcelDate(r['Effective Clock Out Date']),
          clockOutTime: parseExcelTime(r['Effective Clock Out Time']),
          duration: parseFloat(r['Duration']) || 0,
          task: String(r['Scheduled Task Abbreviation'] || ''),
          location: String(r['Location Name'] || ''),
          notes: String(r['Notes'] || '')
        };
      });
      showToast(`Loaded ${importTimeData.length} entries from xlsx`);
    }
    showImportTimePreview();
  } catch(err) {
    showToast('Error reading file: ' + err.message);
    console.error(err);
  }
  e.target.value = '';
});

let pendingImportAction = null;

document.getElementById('importShiftsBtn').addEventListener('click', () => {
  // Group entries by date, pick earliest clock-in and latest clock-out
  const byDate = {};
  importTimeData.forEach(e => {
    const d = e.scheduleDate;
    if (!d) return;
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(e);
  });

  let toImport = 0, toSkip = 0;
  const shiftsToCreate = [];

  Object.keys(byDate).sort().forEach(date => {
    if (data.shifts[date]) { toSkip++; return; }
    const entries = byDate[date];
    // Build time entries from QGenda punches, sorted by clock-in time
    const sortedEntries = [...entries].filter(e => e.clockInTime).sort((a, b) => a.clockInTime.localeCompare(b.clockInTime));
    const timeEntries = sortedEntries.map(e => ({ start: e.clockInTime, end: e.clockOutTime || '' }));
    let earliest = '23:59', latest = '00:00', task = '';
    entries.forEach(e => {
      if (e.clockInTime && e.clockInTime < earliest) earliest = e.clockInTime;
      if (e.clockOutTime && e.clockOutTime > latest) latest = e.clockOutTime;
      if (!task && e.task) task = e.task;
    });
    shiftsToCreate.push({
      date, assignmentType: mapTaskToAssignmentType(task, date),
      startTime: earliest, endTime: latest,
      timeEntries: timeEntries.length > 0 ? timeEntries : [{ start: earliest, end: latest }],
      task
    });
    toImport++;
  });

  if (toImport === 0) {
    showToast(toSkip > 0 ? `All ${toSkip} dates already have shifts` : 'No shifts to import');
    return;
  }

  // Show confirmation modal
  const body = document.getElementById('importConfirmBody');
  body.innerHTML = `<p>Import <strong>${toImport}</strong> shift${toImport > 1 ? 's' : ''} from QGenda?</p>` +
    (toSkip > 0 ? `<p style="font-size:0.8rem;color:var(--text-dim);">${toSkip} date${toSkip > 1 ? 's' : ''} already have shifts and will be skipped.</p>` : '') +
    `<div style="max-height:200px;overflow-y:auto;margin-top:8px;font-size:0.8rem;">` +
    shiftsToCreate.map(s => `<div style="padding:4px 0;border-bottom:1px solid var(--border);">${formatDateShort(s.date)} &mdash; ${getAssignmentTypeName(s.assignmentType)} (${s.startTime}-${s.endTime})</div>`).join('') +
    `</div>`;
  document.getElementById('importConfirmTitle').textContent = 'Import Shifts';

  pendingImportAction = () => {
    shiftsToCreate.forEach(s => {
      data.shifts[s.date] = {
        date: s.date,
        assignmentType: s.assignmentType,
        startTime: s.startTime,
        endTime: s.endTime,
        timeEntries: s.timeEntries || [{ start: s.startTime, end: s.endTime }],
        isHoliday: false,
        forcedOff: false,
        subspecCoverage: false,
        teeCount: 0,
        supervisionStart: '',
        supervisionEnd: ''
      };
    });
    saveData(data);
    updateHeaderPoints();
    showToast(`Imported ${shiftsToCreate.length} shifts`);
    showImportTimePreview();
    renderQgendaRecon();
  };

  document.getElementById('importConfirmModal').classList.remove('hidden');
});

document.getElementById('confirmImport').addEventListener('click', () => {
  document.getElementById('importConfirmModal').classList.add('hidden');
  if (pendingImportAction) { pendingImportAction(); pendingImportAction = null; }
});

document.getElementById('cancelImport').addEventListener('click', () => {
  document.getElementById('importConfirmModal').classList.add('hidden');
  pendingImportAction = null;
});

// ================================================================
// CSV CASE IMPORT (Google Sheet export)
// ================================================================
document.getElementById('csvUploadArea').addEventListener('click', () => document.getElementById('csvFile').click());

document.getElementById('csvFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const text = ev.target.result;
      const result = parseGoogleSheetCSV(text);
      if (result.cases.length === 0) {
        showToast('No cases found in CSV');
        return;
      }
      showCSVImportConfirmation(result);
    } catch(err) {
      showToast('Error parsing CSV: ' + err.message);
      console.error(err);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

function convertAMPMToMilitary(timeStr) {
  if (!timeStr) return '';
  const s = timeStr.trim().toUpperCase();
  // Already military format?
  if (s.match(/^\d{1,2}:\d{2}$/) && !s.includes('AM') && !s.includes('PM')) {
    const [h, m] = s.split(':').map(Number);
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  }
  const match = s.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
  if (!match) return '';
  let [, h, m, ampm] = match;
  h = parseInt(h); m = parseInt(m);
  if (ampm === 'PM' && h !== 12) h += 12;
  if (ampm === 'AM' && h === 12) h = 0;
  return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
}

function parseGoogleSheetCSV(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(l => l);
  const cases = [];
  let detectedYear = null, detectedMonth = null;

  for (const line of lines) {
    // Simple CSV split (handles basic cases, no quoted commas expected in this data)
    const cols = line.split(',').map(c => c.trim());
    if (cols.length < 5) continue;

    // First column should be a date like M/D or M/D/YY
    const dateMatch = cols[0].match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
    if (!dateMatch) continue;

    let [, month, day, year] = dateMatch;
    month = parseInt(month); day = parseInt(day);

    if (year) {
      year = parseInt(year);
      if (year < 100) year += 2000;
    } else {
      // Infer year: if month >= 10, likely 2025; if month <= 6, likely 2026
      year = month >= 7 ? 2025 : 2026;
    }

    if (!detectedYear) { detectedYear = year; detectedMonth = month; }

    const dateStr = year + '-' + String(month).padStart(2,'0') + '-' + String(day).padStart(2,'0');

    // Parse columns based on expected Google Sheet format:
    // Date, Surgeon, Points, Day Start, Day End, pts/hr, Modifiers, Shared?, Notes/Procedure
    const surgeon = cols[1] || '';
    const baseUnits = parseFloat(cols[2]) || 0;
    const startTime = convertAMPMToMilitary(cols[3]);
    const endTime = convertAMPMToMilitary(cols[4]);
    // cols[5] = pts/hr (skip)
    const modifiers = cols[6] || '';
    const shared = cols[7] || '';
    const procedure = cols[8] || cols[cols.length - 1] || '';

    // Parse modifiers
    const isEmergency = /\bE\b/i.test(modifiers);
    let physicalStatus = 'P3';
    const psMatch = modifiers.match(/\b([45])\b/);
    if (psMatch) physicalStatus = 'P' + psMatch[1];

    if (baseUnits <= 0 && !startTime) continue; // skip non-case rows

    cases.push({
      id: genId(),
      caseType: 'standard',
      procedure: procedure,
      baseUnits: baseUnits,
      physicalStatus: physicalStatus,
      startTime: startTime,
      endTime: endTime,
      shiftDate: dateStr,
      isEmergency: isEmergency,
      isMedicalProcedure: false,
      medicalProcedureUnits: 0,
      isAcutePain: false,
      acutePainUnits: 0,
      isHighRiskPeds: false,
      isORCase: false,
      nerveBlock: 'none',
      centralLine: false,
      arterialLine: false,
      pac: false,
      teeAddOn: false,
      notes: surgeon + (shared && shared.toLowerCase() === 'y' ? ' (shared)' : ''),
      timestamp: new Date().toISOString()
    });
  }

  const mn = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const label = detectedMonth ? `${mn[detectedMonth - 1]} ${detectedYear}` : 'Unknown';
  return { cases, label, year: detectedYear, month: detectedMonth };
}

function showCSVImportConfirmation(result) {
  const { cases, label } = result;

  // Check for duplicates
  const existingKeys = new Set(data.cases.map(c => c.shiftDate + '|' + c.startTime));
  const newCases = cases.filter(c => !existingKeys.has(c.shiftDate + '|' + c.startTime));
  const dupes = cases.length - newCases.length;

  if (newCases.length === 0) {
    showToast(`All ${cases.length} cases already exist`);
    return;
  }

  const body = document.getElementById('importConfirmBody');
  body.innerHTML = `<p>Found <strong>${cases.length}</strong> cases for <strong>${label}</strong>.</p>` +
    (dupes > 0 ? `<p style="font-size:0.8rem;color:var(--text-dim);">${dupes} duplicate${dupes > 1 ? 's' : ''} will be skipped.</p>` : '') +
    `<p>Import <strong>${newCases.length}</strong> new case${newCases.length > 1 ? 's' : ''}?</p>`;
  document.getElementById('importConfirmTitle').textContent = 'Import Cases';

  pendingImportAction = () => {
    // Create placeholder shifts for dates without one
    const caseDates = {};
    newCases.forEach(c => {
      if (!caseDates[c.shiftDate]) caseDates[c.shiftDate] = { earliest: '23:59', latest: '00:00' };
      if (c.startTime && c.startTime < caseDates[c.shiftDate].earliest) caseDates[c.shiftDate].earliest = c.startTime;
      if (c.endTime && c.endTime > caseDates[c.shiftDate].latest) caseDates[c.shiftDate].latest = c.endTime;
    });

    let shiftsCreated = 0;
    Object.keys(caseDates).forEach(date => {
      if (!data.shifts[date]) {
        const st = caseDates[date].earliest || '07:00';
        const en = caseDates[date].latest || '17:00';
        data.shifts[date] = {
          date, assignmentType: 'OR',
          startTime: st, endTime: en,
          timeEntries: [{ start: st, end: en }],
          isHoliday: false,
          forcedOff: false, subspecCoverage: false,
          teeCount: 0, supervisionStart: '', supervisionEnd: ''
        };
        shiftsCreated++;
      }
    });

    data.cases.push(...newCases);
    saveData(data);
    updateHeaderPoints();
    showToast(`Imported ${newCases.length} cases` + (shiftsCreated > 0 ? ` and created ${shiftsCreated} placeholder shifts` : ''));
  };

  document.getElementById('importConfirmModal').classList.remove('hidden');
}

function parseProdText(text) {
  const lines = text.split('\n');
  const cases = [];
  let currentDate = '';

  for (const line of lines) {
    const cols = line.split('\t').map(c => c.trim());

    // Try to find date of service pattern: M/D/YY or M/D/YYYY
    const dateMatch = cols[0] && cols[0].match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if (dateMatch) {
      let [, m, d, y] = dateMatch;
      y = parseInt(y);
      if (y < 100) y += 2000;
      currentDate = y + '-' + String(parseInt(m)).padStart(2,'0') + '-' + String(parseInt(d)).padStart(2,'0');
    }

    // Look for a row with military time start/end (4-digit integers)
    // Pattern: ... startTime endTime minutes bonusMin timePoints units ...
    if (!currentDate) continue;

    // Try to extract case data — look for CPT code pattern or numeric start time
    let startTime = '', endTime = '', mdMinutes = 0, totalPoints = 0, units = 0, locCode = '', cptCode = '';

    // Scan columns for military time (3-4 digit number between 0 and 2359)
    for (let i = 0; i < cols.length; i++) {
      const val = cols[i].replace(/[^0-9]/g, '');
      if (val.length >= 3 && val.length <= 4) {
        const num = parseInt(val);
        if (num >= 0 && num <= 2359) {
          if (!startTime) startTime = val;
          else if (!endTime) { endTime = val; break; }
        }
      }
    }

    // Look for Total at end of row
    const lastNum = cols.filter(c => c && !isNaN(parseFloat(c)));
    if (lastNum.length >= 2 && startTime && endTime) {
      totalPoints = parseFloat(lastNum[lastNum.length - 1]) || 0;
      // Find units — typically a small integer near the middle
      for (const c of cols) {
        const n = parseFloat(c);
        if (!isNaN(n) && n >= 1 && n <= 30 && Number.isInteger(n) && c !== startTime && c !== endTime) {
          units = n;
          break;
        }
      }

      // Loc code — short alphabetic code
      for (const c of cols) {
        if (c.match(/^[A-Z]{2,4}$/) && c !== 'Y') {
          locCode = c;
          break;
        }
      }

      // CPT code — 5-digit number
      for (const c of cols) {
        if (c.match(/^\d{5}$/)) {
          cptCode = c;
          break;
        }
      }

      // Only add if we found meaningful data
      if (totalPoints !== 0 || units > 0) {
        cases.push({
          date: currentDate,
          startTime: formatMilitaryTime(startTime),
          endTime: formatMilitaryTime(endTime),
          mdMinutes: mdMinutes,
          totalPoints: totalPoints,
          units: units,
          locCode: locCode,
          cptCode: cptCode
        });
      }
    }
  }

  // Filter out rows that look like subtotals (Day Total rows often lack times)
  return cases.filter(c => c.startTime && c.endTime);
}

function formatMilitaryTime(val) {
  const s = val.padStart(4, '0');
  return s.substring(0, 2) + ':' + s.substring(2, 4);
}

function renderProdRecon() {
  // Load cached
  if (prodData.length === 0) {
    try {
      const cached = localStorage.getItem(PROD_KEY);
      if (cached) prodData = JSON.parse(cached);
    } catch(e) {}
  }

  const container = document.getElementById('prodResults');
  const prefix = `${pYear}-${String(pMonth+1).padStart(2,'0')}`;

  const billingCases = prodData.filter(c => c.date && c.date.startsWith(prefix));
  const trackerCases = data.cases.filter(c => c.shiftDate && c.shiftDate.startsWith(prefix));

  if (prodData.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>Upload a Charge Detail PDF to begin reconciliation.</p></div>';
    return;
  }

  if (billingCases.length === 0 && trackerCases.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>No data for this month.</p></div>';
    return;
  }

  // Group by date
  const bByDate = {};
  billingCases.forEach(c => { if (!bByDate[c.date]) bByDate[c.date] = []; bByDate[c.date].push(c); });

  const tByDate = {};
  trackerCases.forEach(c => { if (!tByDate[c.shiftDate]) tByDate[c.shiftDate] = []; tByDate[c.shiftDate].push(c); });

  const allDates = new Set([...Object.keys(bByDate), ...Object.keys(tByDate)]);
  const sortedDates = [...allDates].sort();

  let bTotalPts = 0, tTotalPts = 0;
  let bTotalCases = 0, tTotalCases = 0;
  let matchCount = 0, issueCount = 0;

  let html = '<div class="card"><h2>Billing vs Tracker by Day</h2>';
  html += '<table class="recon-table"><thead><tr><th>Date</th><th>Billing</th><th>Tracker</th><th>Status</th></tr></thead><tbody>';

  sortedDates.forEach(date => {
    const bDay = bByDate[date] || [];
    const tDay = tByDate[date] || [];
    const shift = data.shifts[date];

    const bPts = bDay.reduce((s, c) => s + c.totalPoints, 0);
    const tPts = tDay.reduce((s, c) => s + calcCasePoints(c, shift), 0);
    bTotalPts += bPts;
    tTotalPts += tPts;
    bTotalCases += bDay.length;
    tTotalCases += tDay.length;

    const caseDiff = Math.abs(bDay.length - tDay.length);
    const ptDiff = Math.abs(bPts - tPts);

    let status = '', rowClass = '';
    if (bDay.length === 0) { status = 'Not in billing'; rowClass = 'warn'; issueCount++; }
    else if (tDay.length === 0) { status = 'Not in tracker'; rowClass = 'miss'; issueCount++; }
    else if (caseDiff === 0 && ptDiff < 5) { status = 'Match'; rowClass = 'match'; matchCount++; }
    else if (caseDiff <= 1 && ptDiff < 15) { status = 'Close'; rowClass = 'warn'; issueCount++; }
    else { status = 'Mismatch'; rowClass = 'miss'; issueCount++; }

    html += `<tr class="${rowClass}">
      <td>${formatDateShort(date)}</td>
      <td>${bDay.length} cases<br><span style="font-size:0.7rem;color:var(--text-dim)">${bPts.toFixed(1)} pts</span></td>
      <td>${tDay.length} cases<br><span style="font-size:0.7rem;color:var(--text-dim)">${tPts.toFixed(1)} pts</span></td>
      <td>${status}</td>
    </tr>`;
  });

  html += '</tbody></table></div>';

  // Per-case matching for days with both billing and tracker data
  let detailHtml = '';
  sortedDates.forEach(date => {
    const bDay = bByDate[date] || [];
    const tDay = tByDate[date] || [];
    if (bDay.length === 0 || tDay.length === 0) return;

    const shift = data.shifts[date];
    detailHtml += `<div class="card"><h3>${formatDateShort(date)} - Case Match</h3>`;
    detailHtml += '<table class="recon-table"><thead><tr><th>Billing</th><th>Tracker</th><th>Status</th></tr></thead><tbody>';

    // Match by start time overlap
    const usedTracker = new Set();
    bDay.forEach(bc => {
      const bStart = timeToMinutes(bc.startTime);
      let bestMatch = null, bestDiff = 999;

      tDay.forEach((tc, idx) => {
        if (usedTracker.has(idx)) return;
        const tStart = timeToMinutes(tc.startTime || '');
        if (!tStart) return;
        const diff = Math.abs(bStart - tStart);
        if (diff < bestDiff && diff <= 30) { bestDiff = diff; bestMatch = idx; }
      });

      if (bestMatch !== null) {
        usedTracker.add(bestMatch);
        const tc = tDay[bestMatch];
        const tcPts = calcCasePoints(tc, shift);
        const ptsDiff = Math.abs(bc.totalPoints - tcPts);
        const rc = ptsDiff < 3 ? 'match' : ptsDiff < 10 ? 'warn' : 'miss';

        detailHtml += `<tr class="${rc}">
          <td>${bc.startTime} ${bc.cptCode || ''}<br><span style="font-size:0.7rem">${bc.totalPoints.toFixed(1)} pts, ${bc.units}u</span></td>
          <td>${tc.startTime || ''} ${escHtml(tc.procedure || tc.caseType)}<br><span style="font-size:0.7rem">${tcPts.toFixed(1)} pts, ${tc.baseUnits || '-'}u</span></td>
          <td>${rc === 'match' ? 'Match' : ptsDiff.toFixed(1) + ' diff'}</td>
        </tr>`;
      } else {
        detailHtml += `<tr class="miss">
          <td>${bc.startTime} ${bc.cptCode || ''}<br><span style="font-size:0.7rem">${bc.totalPoints.toFixed(1)} pts</span></td>
          <td>-</td>
          <td>No match</td>
        </tr>`;
      }
    });

    // Unmatched tracker cases
    tDay.forEach((tc, idx) => {
      if (usedTracker.has(idx)) return;
      const tcPts = calcCasePoints(tc, shift);
      detailHtml += `<tr class="warn">
        <td>-</td>
        <td>${tc.startTime || ''} ${escHtml(tc.procedure || tc.caseType)}<br><span style="font-size:0.7rem">${tcPts.toFixed(1)} pts</span></td>
        <td>Not in billing</td>
      </tr>`;
    });

    detailHtml += '</tbody></table></div>';
  });

  // Summary
  let summary = '<div class="card"><h2>Production Summary</h2><div class="summary-grid">';
  summary += `<div class="summary-item"><div class="label">Billing Points</div><div class="value blue">${bTotalPts.toFixed(1)}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Tracker Points</div><div class="value green">${tTotalPts.toFixed(1)}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Billing Cases</div><div class="value blue">${bTotalCases}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Tracker Cases</div><div class="value green">${tTotalCases}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Days Matched</div><div class="value green">${matchCount}</div></div>`;
  summary += `<div class="summary-item"><div class="label">Days w/ Issues</div><div class="value" style="color:var(--danger)">${issueCount}</div></div>`;
  summary += '</div></div>';

  container.innerHTML = summary + html + detailHtml;
}

// ================================================================
// SERVICE WORKER REGISTRATION
// ================================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// ================================================================
// INIT
// ================================================================
initMilTimeInputs();
setWorkingDate(todayStr());
renderTemplates();
updateHeaderPoints();
updateReconMonthLabels();
updateCLMonthLabel();
updateSupervisionOverlayVisibility();
checkEndTimeNotification();
</script>

</body>
</html>
